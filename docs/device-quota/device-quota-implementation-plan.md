# Device Quota Implementation Plan

**Consolidated from**: Knowledge Base + Backend Agent Reviews
**Date**: January 2025
**Status**: Ready for Implementation

---

## Executive Summary

This plan implements the Device Quota (Dinh Muc Thiet Bi) feature based on:
- **Circular 46/2025/TT-BYT** (effective Feb 15, 2026) - Decentralized quota authority
- **Circular 08/2019/TT-BYT** - Calculation methodology (still valid)
- **Circular 01/2026/TT-BYT** - National centralized procurement

Key architectural decisions incorporate recommendations from backend architecture, security, and API design reviews.

---

## Phase 1: Database Schema (Priority: Critical)

### 1.1 Equipment Category Hierarchy with ltree

```sql
-- Enable ltree extension for hierarchical queries
CREATE EXTENSION IF NOT EXISTS ltree;

-- Equipment category hierarchy (global, tenant-agnostic)
CREATE TABLE public.nhom_thiet_bi_dinh_muc (
  id bigint generated by default as identity not null primary key,
  parent_id bigint references nhom_thiet_bi_dinh_muc(id),
  ma_nhom text not null,                   -- e.g., "I", "A", "1", "a"
  ten_nhom text not null,                  -- Vietnamese name
  ten_nhom_en text,                        -- English name
  loai_cap text not null                   -- 'cap_nhom', 'cap_hang_muc', 'cap_thiet_bi'
    CHECK (loai_cap IN ('cap_nhom', 'cap_hang_muc', 'cap_thiet_bi')),
  phan_loai text                           -- 'A' (đặc thù) or 'B' (khác)
    CHECK (phan_loai IS NULL OR phan_loai IN ('A', 'B')),
  path ltree,                              -- Materialized path for fast hierarchy queries
  thu_tu int default 0,                    -- Display order
  is_leaf boolean default false,           -- True for equipment items
  don_vi_tinh text,                        -- Unit (only for leaf nodes)
  ghi_chu text,
  created_at timestamp with time zone default now(),
  updated_at timestamp with time zone default now(),

  CONSTRAINT unique_ma_nhom_per_parent UNIQUE (parent_id, ma_nhom)
);

CREATE INDEX idx_nhom_thiet_bi_path ON nhom_thiet_bi_dinh_muc USING gist(path);
CREATE INDEX idx_nhom_thiet_bi_parent ON nhom_thiet_bi_dinh_muc(parent_id);
CREATE INDEX idx_nhom_thiet_bi_phan_loai ON nhom_thiet_bi_dinh_muc(phan_loai) WHERE phan_loai IS NOT NULL;

-- Trigger to auto-update path on insert/update
CREATE OR REPLACE FUNCTION update_nhom_thiet_bi_path()
RETURNS TRIGGER LANGUAGE plpgsql AS $$
BEGIN
  IF NEW.parent_id IS NULL THEN
    NEW.path := text2ltree(NEW.id::text);
  ELSE
    SELECT path || text2ltree(NEW.id::text)
    INTO NEW.path
    FROM nhom_thiet_bi_dinh_muc WHERE id = NEW.parent_id;
  END IF;
  RETURN NEW;
END;
$$;

CREATE TRIGGER trg_nhom_thiet_bi_path
BEFORE INSERT OR UPDATE OF parent_id ON nhom_thiet_bi_dinh_muc
FOR EACH ROW EXECUTE FUNCTION update_nhom_thiet_bi_path();
```

### 1.2 Quota Decisions with Immutability Controls

```sql
-- Quota decision (per-tenant, versioned)
CREATE TABLE public.quyet_dinh_dinh_muc (
  id bigint generated by default as identity not null primary key,
  don_vi_id bigint references don_vi(id) not null,
  so_quyet_dinh text not null,             -- e.g., "15/QĐ-BVBM"
  ngay_ban_hanh date not null,             -- Date signed
  nguoi_ky text,                           -- Name of Director
  chuc_vu_nguoi_ky text,                   -- Position (Giám đốc)
  hieu_luc_tu date not null,               -- Valid from
  hieu_luc_den date,                       -- Valid until (null = indefinite)
  trang_thai text default 'draft'          -- 'draft', 'active', 'replaced'
    CHECK (trang_thai IN ('draft', 'active', 'replaced')),
  file_dinh_kem text,                      -- URL to scanned PDF
  da_cong_khai boolean default false,      -- Published to Ministry portal?
  ngay_cong_khai timestamp with time zone, -- When published
  ghi_chu text,

  -- Version control
  phien_ban int default 1,
  thay_the_cho_id bigint references quyet_dinh_dinh_muc(id),

  -- Audit fields
  created_by bigint references nhan_vien(id),
  updated_by bigint references nhan_vien(id),
  created_at timestamp with time zone default now(),
  updated_at timestamp with time zone default now(),

  CONSTRAINT unique_so_quyet_dinh_per_don_vi UNIQUE (don_vi_id, so_quyet_dinh)
);

CREATE INDEX idx_quyet_dinh_don_vi ON quyet_dinh_dinh_muc(don_vi_id);
CREATE INDEX idx_quyet_dinh_trang_thai ON quyet_dinh_dinh_muc(don_vi_id, trang_thai);
CREATE INDEX idx_quyet_dinh_hieu_luc ON quyet_dinh_dinh_muc(don_vi_id, hieu_luc_tu, hieu_luc_den);

-- Immutability trigger for published decisions
CREATE OR REPLACE FUNCTION prevent_published_decision_changes()
RETURNS TRIGGER LANGUAGE plpgsql AS $$
BEGIN
  IF OLD.da_cong_khai = true THEN
    -- Allow only specific field updates on published decisions
    IF OLD.trang_thai != NEW.trang_thai AND NEW.trang_thai = 'replaced' THEN
      -- Allow status change to 'replaced' only
      RETURN NEW;
    END IF;

    IF OLD.file_dinh_kem IS DISTINCT FROM NEW.file_dinh_kem THEN
      -- Allow attachment updates
      NEW.ngay_ban_hanh := OLD.ngay_ban_hanh;
      NEW.so_quyet_dinh := OLD.so_quyet_dinh;
      NEW.nguoi_ky := OLD.nguoi_ky;
      RETURN NEW;
    END IF;

    RAISE EXCEPTION 'Cannot modify published quota decision. Create a new version instead.';
  END IF;

  RETURN NEW;
END;
$$;

CREATE TRIGGER trg_prevent_published_changes
BEFORE UPDATE ON quyet_dinh_dinh_muc
FOR EACH ROW EXECUTE FUNCTION prevent_published_decision_changes();
```

### 1.3 Quota Details with Tenant Isolation

```sql
-- Quota line items (linked to decision AND tenant)
CREATE TABLE public.chi_tiet_dinh_muc (
  id bigint generated by default as identity not null primary key,
  quyet_dinh_id bigint references quyet_dinh_dinh_muc(id) not null,
  don_vi_id bigint references don_vi(id) not null,  -- Denormalized for tenant isolation
  nhom_thiet_bi_id bigint references nhom_thiet_bi_dinh_muc(id) not null,
  don_vi_tinh text not null,               -- e.g., "Hệ thống", "Cái"
  so_luong_dinh_muc int not null           -- Maximum allowed quantity
    CHECK (so_luong_dinh_muc > 0),
  so_luong_toi_thieu int                   -- Minimum required (optional)
    CHECK (so_luong_toi_thieu IS NULL OR so_luong_toi_thieu >= 0),
  khoa_phong_id bigint references khoa_phong(id), -- Specific department (optional)
  can_cu_tinh_toan text,                   -- Calculation basis per Circular 08/2019
  ghi_chu text,

  -- National centralized procurement flag (Circular 01/2026)
  mua_sam_tap_trung boolean default false,

  created_at timestamp with time zone default now(),
  updated_at timestamp with time zone default now(),

  CONSTRAINT unique_chi_tiet_per_quyet_dinh UNIQUE (quyet_dinh_id, nhom_thiet_bi_id, khoa_phong_id)
);

CREATE INDEX idx_chi_tiet_don_vi ON chi_tiet_dinh_muc(don_vi_id);
CREATE INDEX idx_chi_tiet_quyet_dinh ON chi_tiet_dinh_muc(quyet_dinh_id);
CREATE INDEX idx_chi_tiet_nhom ON chi_tiet_dinh_muc(nhom_thiet_bi_id);
CREATE INDEX idx_chi_tiet_tap_trung ON chi_tiet_dinh_muc(mua_sam_tap_trung) WHERE mua_sam_tap_trung = true;

-- Auto-populate don_vi_id from parent decision
CREATE OR REPLACE FUNCTION sync_chi_tiet_don_vi()
RETURNS TRIGGER LANGUAGE plpgsql AS $$
BEGIN
  SELECT don_vi_id INTO NEW.don_vi_id
  FROM quyet_dinh_dinh_muc
  WHERE id = NEW.quyet_dinh_id;
  RETURN NEW;
END;
$$;

CREATE TRIGGER trg_sync_chi_tiet_don_vi
BEFORE INSERT OR UPDATE OF quyet_dinh_id ON chi_tiet_dinh_muc
FOR EACH ROW EXECUTE FUNCTION sync_chi_tiet_don_vi();
```

### 1.4 Audit Log (Append-Only)

```sql
-- Immutable audit log
CREATE TABLE public.lich_su_dinh_muc (
  id bigint generated by default as identity not null primary key,
  chi_tiet_id bigint references chi_tiet_dinh_muc(id),
  quyet_dinh_id bigint references quyet_dinh_dinh_muc(id),
  don_vi_id bigint references don_vi(id) not null,  -- For tenant isolation
  thao_tac text not null                   -- 'tao', 'cap_nhat', 'dieu_chinh', 'huy', 'cong_khai'
    CHECK (thao_tac IN ('tao', 'cap_nhat', 'dieu_chinh', 'huy', 'cong_khai')),
  snapshot_truoc jsonb,
  snapshot_sau jsonb,
  ly_do text,
  thuc_hien_boi bigint references nhan_vien(id) not null,
  client_info jsonb,                       -- IP, user agent for forensics
  thoi_diem timestamp with time zone default now() not null
);

-- Append-only constraint
CREATE RULE prevent_lich_su_update AS
ON UPDATE TO lich_su_dinh_muc DO INSTEAD NOTHING;

CREATE RULE prevent_lich_su_delete AS
ON DELETE TO lich_su_dinh_muc DO INSTEAD NOTHING;

CREATE INDEX idx_lich_su_don_vi ON lich_su_dinh_muc(don_vi_id);
CREATE INDEX idx_lich_su_quyet_dinh ON lich_su_dinh_muc(quyet_dinh_id);
CREATE INDEX idx_lich_su_thoi_diem ON lich_su_dinh_muc(thoi_diem DESC);
```

### 1.5 Link to Existing Equipment

```sql
-- Add foreign key to thiet_bi table (migration)
ALTER TABLE public.thiet_bi
ADD COLUMN IF NOT EXISTS nhom_dinh_muc_id bigint REFERENCES nhom_thiet_bi_dinh_muc(id);

CREATE INDEX idx_thiet_bi_nhom_dinh_muc ON thiet_bi(nhom_dinh_muc_id) WHERE nhom_dinh_muc_id IS NOT NULL;

-- Compliance view: actual vs quota
CREATE OR REPLACE VIEW v_so_sanh_dinh_muc AS
SELECT
  c.don_vi_id,
  c.quyet_dinh_id,
  c.nhom_thiet_bi_id,
  n.ten_nhom,
  n.phan_loai,
  c.don_vi_tinh,
  c.so_luong_dinh_muc AS quota,
  c.so_luong_toi_thieu AS minimum,
  COALESCE(actual.so_luong, 0) AS actual_count,
  CASE
    WHEN COALESCE(actual.so_luong, 0) > c.so_luong_dinh_muc THEN 'vuot'
    WHEN COALESCE(actual.so_luong, 0) < COALESCE(c.so_luong_toi_thieu, 0) THEN 'thieu'
    ELSE 'dat'
  END AS trang_thai_tuan_thu
FROM chi_tiet_dinh_muc c
JOIN nhom_thiet_bi_dinh_muc n ON n.id = c.nhom_thiet_bi_id
JOIN quyet_dinh_dinh_muc q ON q.id = c.quyet_dinh_id AND q.trang_thai = 'active'
LEFT JOIN LATERAL (
  SELECT COUNT(*) AS so_luong
  FROM thiet_bi t
  WHERE t.don_vi_id = c.don_vi_id
    AND t.nhom_dinh_muc_id = c.nhom_thiet_bi_id
    AND t.trang_thai NOT IN ('thanh_ly', 'mat')
) actual ON true;
```

---

## Phase 2: RPC Functions (Security-First)

### 2.1 Category Hierarchy (Global Read)

```sql
-- List equipment categories (tree format)
CREATE OR REPLACE FUNCTION dinh_muc_nhom_thiet_bi_list(
  p_phan_loai text DEFAULT NULL,
  p_parent_id bigint DEFAULT NULL,
  p_include_descendants boolean DEFAULT false
)
RETURNS TABLE (
  id bigint,
  parent_id bigint,
  ma_nhom text,
  ten_nhom text,
  ten_nhom_en text,
  loai_cap text,
  phan_loai text,
  path ltree,
  level int,
  thu_tu int,
  is_leaf boolean,
  don_vi_tinh text
)
LANGUAGE plpgsql SECURITY DEFINER SET search_path = public
AS $$
DECLARE
  v_role TEXT := current_setting('request.jwt.claims', true)::json->>'app_role';
BEGIN
  -- All authenticated users can view categories
  IF v_role IS NULL THEN
    RAISE EXCEPTION 'Authentication required';
  END IF;

  RETURN QUERY
  SELECT
    n.id, n.parent_id, n.ma_nhom, n.ten_nhom, n.ten_nhom_en,
    n.loai_cap, n.phan_loai, n.path,
    nlevel(n.path) AS level,
    n.thu_tu, n.is_leaf, n.don_vi_tinh
  FROM nhom_thiet_bi_dinh_muc n
  WHERE (p_phan_loai IS NULL OR n.phan_loai = p_phan_loai)
    AND (
      p_parent_id IS NULL
      OR n.parent_id = p_parent_id
      OR (p_include_descendants AND n.path <@ (SELECT path FROM nhom_thiet_bi_dinh_muc WHERE id = p_parent_id))
    )
  ORDER BY n.path, n.thu_tu;
END;
$$;

GRANT EXECUTE ON FUNCTION dinh_muc_nhom_thiet_bi_list TO authenticated;
```

### 2.2 Quota Decisions CRUD

```sql
-- List quota decisions for tenant
CREATE OR REPLACE FUNCTION dinh_muc_quyet_dinh_list(
  p_don_vi bigint DEFAULT NULL,
  p_trang_thai text DEFAULT NULL,
  p_page int DEFAULT 1,
  p_page_size int DEFAULT 20
)
RETURNS jsonb
LANGUAGE plpgsql SECURITY DEFINER SET search_path = public
AS $$
DECLARE
  v_role TEXT := current_setting('request.jwt.claims', true)::json->>'app_role';
  v_don_vi TEXT := current_setting('request.jwt.claims', true)::json->>'don_vi';
  v_offset int;
  v_total int;
  v_items jsonb;
BEGIN
  -- Permission check
  IF v_role IS NULL THEN
    RAISE EXCEPTION 'Authentication required';
  END IF;

  -- Tenant isolation
  IF v_role NOT IN ('global', 'admin', 'regional_leader') THEN
    p_don_vi := v_don_vi::bigint;
  END IF;

  v_offset := (p_page - 1) * p_page_size;

  -- Count total
  SELECT COUNT(*) INTO v_total
  FROM quyet_dinh_dinh_muc
  WHERE (p_don_vi IS NULL OR don_vi_id = p_don_vi)
    AND (p_trang_thai IS NULL OR trang_thai = p_trang_thai);

  -- Fetch items
  SELECT jsonb_agg(row_to_json(q)::jsonb)
  INTO v_items
  FROM (
    SELECT
      qd.id, qd.don_vi_id, qd.so_quyet_dinh, qd.ngay_ban_hanh,
      qd.nguoi_ky, qd.chuc_vu_nguoi_ky,
      qd.hieu_luc_tu, qd.hieu_luc_den,
      qd.trang_thai, qd.da_cong_khai, qd.ngay_cong_khai,
      qd.phien_ban, qd.thay_the_cho_id,
      qd.created_at, qd.updated_at,
      dv.ten_don_vi
    FROM quyet_dinh_dinh_muc qd
    JOIN don_vi dv ON dv.id = qd.don_vi_id
    WHERE (p_don_vi IS NULL OR qd.don_vi_id = p_don_vi)
      AND (p_trang_thai IS NULL OR qd.trang_thai = p_trang_thai)
    ORDER BY qd.ngay_ban_hanh DESC, qd.id DESC
    LIMIT p_page_size OFFSET v_offset
  ) q;

  RETURN jsonb_build_object(
    'items', COALESCE(v_items, '[]'::jsonb),
    'total', v_total,
    'page', p_page,
    'page_size', p_page_size,
    'pages', CEIL(v_total::float / p_page_size)
  );
END;
$$;

GRANT EXECUTE ON FUNCTION dinh_muc_quyet_dinh_list TO authenticated;

-- Create quota decision
CREATE OR REPLACE FUNCTION dinh_muc_quyet_dinh_create(
  p_so_quyet_dinh text,
  p_ngay_ban_hanh date,
  p_nguoi_ky text,
  p_chuc_vu_nguoi_ky text,
  p_hieu_luc_tu date,
  p_hieu_luc_den date DEFAULT NULL,
  p_ghi_chu text DEFAULT NULL,
  p_don_vi bigint DEFAULT NULL
)
RETURNS jsonb
LANGUAGE plpgsql SECURITY DEFINER SET search_path = public
AS $$
DECLARE
  v_role TEXT := current_setting('request.jwt.claims', true)::json->>'app_role';
  v_don_vi TEXT := current_setting('request.jwt.claims', true)::json->>'don_vi';
  v_user_id TEXT := current_setting('request.jwt.claims', true)::json->>'user_id';
  v_id bigint;
BEGIN
  -- Permission: only to_qltb or global can create
  IF v_role NOT IN ('global', 'admin', 'to_qltb') THEN
    RAISE EXCEPTION 'Insufficient permissions to create quota decisions';
  END IF;

  -- Tenant isolation
  IF v_role NOT IN ('global', 'admin') THEN
    p_don_vi := v_don_vi::bigint;
  END IF;

  IF p_don_vi IS NULL THEN
    RAISE EXCEPTION 'don_vi_id is required';
  END IF;

  -- Validation
  IF p_hieu_luc_tu < p_ngay_ban_hanh THEN
    RAISE EXCEPTION 'Effective date cannot be before signing date';
  END IF;

  INSERT INTO quyet_dinh_dinh_muc (
    don_vi_id, so_quyet_dinh, ngay_ban_hanh,
    nguoi_ky, chuc_vu_nguoi_ky,
    hieu_luc_tu, hieu_luc_den,
    trang_thai, ghi_chu,
    created_by, updated_by
  ) VALUES (
    p_don_vi, p_so_quyet_dinh, p_ngay_ban_hanh,
    p_nguoi_ky, p_chuc_vu_nguoi_ky,
    p_hieu_luc_tu, p_hieu_luc_den,
    'draft', p_ghi_chu,
    v_user_id::bigint, v_user_id::bigint
  )
  RETURNING id INTO v_id;

  -- Audit log
  INSERT INTO lich_su_dinh_muc (quyet_dinh_id, don_vi_id, thao_tac, snapshot_sau, thuc_hien_boi)
  SELECT v_id, p_don_vi, 'tao', row_to_json(q)::jsonb, v_user_id::bigint
  FROM quyet_dinh_dinh_muc q WHERE q.id = v_id;

  RETURN jsonb_build_object('id', v_id, 'success', true);
END;
$$;

GRANT EXECUTE ON FUNCTION dinh_muc_quyet_dinh_create TO authenticated;

-- Activate quota decision
CREATE OR REPLACE FUNCTION dinh_muc_quyet_dinh_activate(
  p_id bigint,
  p_don_vi bigint DEFAULT NULL
)
RETURNS jsonb
LANGUAGE plpgsql SECURITY DEFINER SET search_path = public
AS $$
DECLARE
  v_role TEXT := current_setting('request.jwt.claims', true)::json->>'app_role';
  v_don_vi TEXT := current_setting('request.jwt.claims', true)::json->>'don_vi';
  v_user_id TEXT := current_setting('request.jwt.claims', true)::json->>'user_id';
  v_decision RECORD;
  v_old_active_id bigint;
BEGIN
  -- Permission check
  IF v_role NOT IN ('global', 'admin', 'to_qltb') THEN
    RAISE EXCEPTION 'Insufficient permissions';
  END IF;

  -- Tenant isolation
  IF v_role NOT IN ('global', 'admin') THEN
    p_don_vi := v_don_vi::bigint;
  END IF;

  -- Fetch decision with tenant check
  SELECT * INTO v_decision
  FROM quyet_dinh_dinh_muc
  WHERE id = p_id AND (p_don_vi IS NULL OR don_vi_id = p_don_vi);

  IF NOT FOUND THEN
    RAISE EXCEPTION 'Quota decision not found or access denied';
  END IF;

  IF v_decision.trang_thai != 'draft' THEN
    RAISE EXCEPTION 'Only draft decisions can be activated';
  END IF;

  -- Deactivate current active decision for same tenant
  SELECT id INTO v_old_active_id
  FROM quyet_dinh_dinh_muc
  WHERE don_vi_id = v_decision.don_vi_id AND trang_thai = 'active';

  IF v_old_active_id IS NOT NULL THEN
    UPDATE quyet_dinh_dinh_muc
    SET trang_thai = 'replaced', updated_by = v_user_id::bigint, updated_at = now()
    WHERE id = v_old_active_id;

    -- Log deactivation
    INSERT INTO lich_su_dinh_muc (quyet_dinh_id, don_vi_id, thao_tac, ly_do, thuc_hien_boi)
    VALUES (v_old_active_id, v_decision.don_vi_id, 'huy', 'Replaced by decision ' || p_id, v_user_id::bigint);
  END IF;

  -- Activate new decision
  UPDATE quyet_dinh_dinh_muc
  SET trang_thai = 'active',
      thay_the_cho_id = v_old_active_id,
      updated_by = v_user_id::bigint,
      updated_at = now()
  WHERE id = p_id;

  -- Audit log
  INSERT INTO lich_su_dinh_muc (quyet_dinh_id, don_vi_id, thao_tac, thuc_hien_boi)
  VALUES (p_id, v_decision.don_vi_id, 'cap_nhat', v_user_id::bigint);

  RETURN jsonb_build_object('success', true, 'replaced_id', v_old_active_id);
END;
$$;

GRANT EXECUTE ON FUNCTION dinh_muc_quyet_dinh_activate TO authenticated;

-- Publish quota decision (mark as public)
CREATE OR REPLACE FUNCTION dinh_muc_quyet_dinh_publish(
  p_id bigint,
  p_don_vi bigint DEFAULT NULL
)
RETURNS jsonb
LANGUAGE plpgsql SECURITY DEFINER SET search_path = public
AS $$
DECLARE
  v_role TEXT := current_setting('request.jwt.claims', true)::json->>'app_role';
  v_don_vi TEXT := current_setting('request.jwt.claims', true)::json->>'don_vi';
  v_user_id TEXT := current_setting('request.jwt.claims', true)::json->>'user_id';
  v_decision RECORD;
BEGIN
  -- Permission: only to_qltb or global
  IF v_role NOT IN ('global', 'admin', 'to_qltb') THEN
    RAISE EXCEPTION 'Insufficient permissions';
  END IF;

  -- Tenant isolation
  IF v_role NOT IN ('global', 'admin') THEN
    p_don_vi := v_don_vi::bigint;
  END IF;

  SELECT * INTO v_decision
  FROM quyet_dinh_dinh_muc
  WHERE id = p_id AND (p_don_vi IS NULL OR don_vi_id = p_don_vi);

  IF NOT FOUND THEN
    RAISE EXCEPTION 'Quota decision not found or access denied';
  END IF;

  IF v_decision.trang_thai != 'active' THEN
    RAISE EXCEPTION 'Only active decisions can be published';
  END IF;

  IF v_decision.da_cong_khai THEN
    RAISE EXCEPTION 'Decision already published';
  END IF;

  UPDATE quyet_dinh_dinh_muc
  SET da_cong_khai = true, ngay_cong_khai = now(), updated_by = v_user_id::bigint
  WHERE id = p_id;

  -- Audit log
  INSERT INTO lich_su_dinh_muc (quyet_dinh_id, don_vi_id, thao_tac, thuc_hien_boi)
  VALUES (p_id, v_decision.don_vi_id, 'cong_khai', v_user_id::bigint);

  RETURN jsonb_build_object('success', true, 'published_at', now());
END;
$$;

GRANT EXECUTE ON FUNCTION dinh_muc_quyet_dinh_publish TO authenticated;
```

### 2.3 Quota Details CRUD

```sql
-- Add quota detail line item
CREATE OR REPLACE FUNCTION dinh_muc_chi_tiet_upsert(
  p_quyet_dinh_id bigint,
  p_nhom_thiet_bi_id bigint,
  p_don_vi_tinh text,
  p_so_luong_dinh_muc int,
  p_so_luong_toi_thieu int DEFAULT NULL,
  p_khoa_phong_id bigint DEFAULT NULL,
  p_can_cu_tinh_toan text DEFAULT NULL,
  p_mua_sam_tap_trung boolean DEFAULT false,
  p_ghi_chu text DEFAULT NULL,
  p_don_vi bigint DEFAULT NULL
)
RETURNS jsonb
LANGUAGE plpgsql SECURITY DEFINER SET search_path = public
AS $$
DECLARE
  v_role TEXT := current_setting('request.jwt.claims', true)::json->>'app_role';
  v_don_vi TEXT := current_setting('request.jwt.claims', true)::json->>'don_vi';
  v_user_id TEXT := current_setting('request.jwt.claims', true)::json->>'user_id';
  v_decision RECORD;
  v_id bigint;
  v_is_insert boolean;
  v_action text;
BEGIN
  -- Permission check
  IF v_role NOT IN ('global', 'admin', 'to_qltb') THEN
    RAISE EXCEPTION 'Insufficient permissions';
  END IF;

  -- Tenant isolation
  IF v_role NOT IN ('global', 'admin') THEN
    p_don_vi := v_don_vi::bigint;
  END IF;

  -- Verify decision exists and belongs to tenant
  SELECT * INTO v_decision
  FROM quyet_dinh_dinh_muc
  WHERE id = p_quyet_dinh_id AND (p_don_vi IS NULL OR don_vi_id = p_don_vi);

  IF NOT FOUND THEN
    RAISE EXCEPTION 'Quota decision not found or access denied';
  END IF;

  IF v_decision.da_cong_khai THEN
    RAISE EXCEPTION 'Cannot modify published decision. Create a new version.';
  END IF;

  -- Upsert detail
  INSERT INTO chi_tiet_dinh_muc (
    quyet_dinh_id, don_vi_id, nhom_thiet_bi_id, don_vi_tinh,
    so_luong_dinh_muc, so_luong_toi_thieu, khoa_phong_id,
    can_cu_tinh_toan, mua_sam_tap_trung, ghi_chu
  ) VALUES (
    p_quyet_dinh_id, v_decision.don_vi_id, p_nhom_thiet_bi_id, p_don_vi_tinh,
    p_so_luong_dinh_muc, p_so_luong_toi_thieu, p_khoa_phong_id,
    p_can_cu_tinh_toan, p_mua_sam_tap_trung, p_ghi_chu
  )
  ON CONFLICT (quyet_dinh_id, nhom_thiet_bi_id, khoa_phong_id) DO UPDATE SET
    don_vi_tinh = EXCLUDED.don_vi_tinh,
    so_luong_dinh_muc = EXCLUDED.so_luong_dinh_muc,
    so_luong_toi_thieu = EXCLUDED.so_luong_toi_thieu,
    can_cu_tinh_toan = EXCLUDED.can_cu_tinh_toan,
    mua_sam_tap_trung = EXCLUDED.mua_sam_tap_trung,
    ghi_chu = EXCLUDED.ghi_chu,
    updated_at = now()
  RETURNING id, (xmax = 0) AS is_insert INTO v_id, v_is_insert;

  v_action := CASE WHEN v_is_insert THEN 'tao' ELSE 'cap_nhat' END;

  -- Audit log
  INSERT INTO lich_su_dinh_muc (chi_tiet_id, quyet_dinh_id, don_vi_id, thao_tac, thuc_hien_boi)
  VALUES (v_id, p_quyet_dinh_id, v_decision.don_vi_id, v_action, v_user_id::bigint);

  RETURN jsonb_build_object('id', v_id, 'action', v_action);
END;
$$;

GRANT EXECUTE ON FUNCTION dinh_muc_chi_tiet_upsert TO authenticated;

-- List quota details for a decision
CREATE OR REPLACE FUNCTION dinh_muc_chi_tiet_list(
  p_quyet_dinh_id bigint,
  p_don_vi bigint DEFAULT NULL
)
RETURNS jsonb
LANGUAGE plpgsql SECURITY DEFINER SET search_path = public
AS $$
DECLARE
  v_role TEXT := current_setting('request.jwt.claims', true)::json->>'app_role';
  v_don_vi TEXT := current_setting('request.jwt.claims', true)::json->>'don_vi';
  v_items jsonb;
BEGIN
  IF v_role IS NULL THEN
    RAISE EXCEPTION 'Authentication required';
  END IF;

  -- Tenant isolation
  IF v_role NOT IN ('global', 'admin', 'regional_leader') THEN
    p_don_vi := v_don_vi::bigint;
  END IF;

  SELECT jsonb_agg(row_to_json(c)::jsonb ORDER BY n.path, n.thu_tu)
  INTO v_items
  FROM (
    SELECT
      cd.id, cd.nhom_thiet_bi_id, cd.don_vi_tinh,
      cd.so_luong_dinh_muc, cd.so_luong_toi_thieu,
      cd.khoa_phong_id, kp.ten_khoa_phong,
      cd.can_cu_tinh_toan, cd.mua_sam_tap_trung, cd.ghi_chu,
      n.ma_nhom, n.ten_nhom, n.phan_loai, n.path, n.loai_cap
    FROM chi_tiet_dinh_muc cd
    JOIN quyet_dinh_dinh_muc qd ON qd.id = cd.quyet_dinh_id
    JOIN nhom_thiet_bi_dinh_muc n ON n.id = cd.nhom_thiet_bi_id
    LEFT JOIN khoa_phong kp ON kp.id = cd.khoa_phong_id
    WHERE cd.quyet_dinh_id = p_quyet_dinh_id
      AND (p_don_vi IS NULL OR qd.don_vi_id = p_don_vi)
  ) c
  JOIN nhom_thiet_bi_dinh_muc n ON n.id = c.nhom_thiet_bi_id;

  RETURN COALESCE(v_items, '[]'::jsonb);
END;
$$;

GRANT EXECUTE ON FUNCTION dinh_muc_chi_tiet_list TO authenticated;
```

### 2.4 Compliance Report

```sql
-- Get compliance status for a tenant
CREATE OR REPLACE FUNCTION dinh_muc_bao_cao_tuan_thu(
  p_don_vi bigint DEFAULT NULL
)
RETURNS jsonb
LANGUAGE plpgsql SECURITY DEFINER SET search_path = public
AS $$
DECLARE
  v_role TEXT := current_setting('request.jwt.claims', true)::json->>'app_role';
  v_don_vi TEXT := current_setting('request.jwt.claims', true)::json->>'don_vi';
  v_result jsonb;
BEGIN
  IF v_role IS NULL THEN
    RAISE EXCEPTION 'Authentication required';
  END IF;

  -- Tenant isolation
  IF v_role NOT IN ('global', 'admin', 'regional_leader') THEN
    p_don_vi := v_don_vi::bigint;
  END IF;

  IF p_don_vi IS NULL THEN
    RAISE EXCEPTION 'don_vi_id is required';
  END IF;

  SELECT jsonb_build_object(
    'don_vi_id', p_don_vi,
    'quyet_dinh', (
      SELECT row_to_json(qd)::jsonb
      FROM quyet_dinh_dinh_muc qd
      WHERE qd.don_vi_id = p_don_vi AND qd.trang_thai = 'active'
      LIMIT 1
    ),
    'summary', (
      SELECT jsonb_build_object(
        'total_categories', COUNT(*),
        'dat', COUNT(*) FILTER (WHERE trang_thai_tuan_thu = 'dat'),
        'thieu', COUNT(*) FILTER (WHERE trang_thai_tuan_thu = 'thieu'),
        'vuot', COUNT(*) FILTER (WHERE trang_thai_tuan_thu = 'vuot')
      )
      FROM v_so_sanh_dinh_muc
      WHERE don_vi_id = p_don_vi
    ),
    'details', (
      SELECT jsonb_agg(row_to_json(v)::jsonb)
      FROM v_so_sanh_dinh_muc v
      WHERE v.don_vi_id = p_don_vi
    )
  ) INTO v_result;

  RETURN v_result;
END;
$$;

GRANT EXECUTE ON FUNCTION dinh_muc_bao_cao_tuan_thu TO authenticated;
```

---

## Phase 3: API Proxy Whitelist

Add to `src/app/api/rpc/[fn]/route.ts`:

```typescript
const ALLOWED_FUNCTIONS = [
  // ... existing functions ...

  // Device Quota functions
  'dinh_muc_nhom_thiet_bi_list',
  'dinh_muc_quyet_dinh_list',
  'dinh_muc_quyet_dinh_create',
  'dinh_muc_quyet_dinh_update',
  'dinh_muc_quyet_dinh_activate',
  'dinh_muc_quyet_dinh_publish',
  'dinh_muc_chi_tiet_list',
  'dinh_muc_chi_tiet_upsert',
  'dinh_muc_chi_tiet_delete',
  'dinh_muc_bao_cao_tuan_thu',
  'dinh_muc_lich_su_list',
] as const;
```

---

## Phase 4: TypeScript Types

Add to `src/types/database.ts`:

```typescript
// Device Quota Types
export interface NhomThietBiDinhMuc {
  id: number;
  parent_id: number | null;
  ma_nhom: string;
  ten_nhom: string;
  ten_nhom_en: string | null;
  loai_cap: 'cap_nhom' | 'cap_hang_muc' | 'cap_thiet_bi';
  phan_loai: 'A' | 'B' | null;
  path: string;
  thu_tu: number;
  is_leaf: boolean;
  don_vi_tinh: string | null;
  ghi_chu: string | null;
  created_at: string;
}

export interface QuyetDinhDinhMuc {
  id: number;
  don_vi_id: number;
  so_quyet_dinh: string;
  ngay_ban_hanh: string; // date
  nguoi_ky: string | null;
  chuc_vu_nguoi_ky: string | null;
  hieu_luc_tu: string; // date
  hieu_luc_den: string | null; // date
  trang_thai: 'draft' | 'active' | 'replaced';
  file_dinh_kem: string | null;
  da_cong_khai: boolean;
  ngay_cong_khai: string | null;
  ghi_chu: string | null;
  phien_ban: number;
  thay_the_cho_id: number | null;
  created_by: number | null;
  updated_by: number | null;
  created_at: string;
  updated_at: string;
}

export interface ChiTietDinhMuc {
  id: number;
  quyet_dinh_id: number;
  don_vi_id: number;
  nhom_thiet_bi_id: number;
  don_vi_tinh: string;
  so_luong_dinh_muc: number;
  so_luong_toi_thieu: number | null;
  khoa_phong_id: number | null;
  can_cu_tinh_toan: string | null;
  mua_sam_tap_trung: boolean;
  ghi_chu: string | null;
  created_at: string;
  updated_at: string;
}

export type TrangThaiTuanThu = 'dat' | 'thieu' | 'vuot';

export interface SoSanhDinhMuc {
  don_vi_id: number;
  quyet_dinh_id: number;
  nhom_thiet_bi_id: number;
  ten_nhom: string;
  phan_loai: 'A' | 'B' | null;
  don_vi_tinh: string;
  quota: number;
  minimum: number | null;
  actual_count: number;
  trang_thai_tuan_thu: TrangThaiTuanThu;
}
```

---

## Phase 5: TanStack Query Hooks

Create `src/hooks/useDeviceQuota.ts`:

```typescript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { callRpc } from '@/lib/rpc-client';
import { useSession } from '@/hooks/useSession';

export const deviceQuotaKeys = {
  all: ['device-quota'] as const,
  categories: (phanLoai?: string) => [...deviceQuotaKeys.all, 'categories', { phanLoai }] as const,
  decisions: (donViId: number, trangThai?: string) =>
    [...deviceQuotaKeys.all, 'decisions', { donViId, trangThai }] as const,
  decision: (id: number) => [...deviceQuotaKeys.all, 'decision', id] as const,
  details: (quyetDinhId: number) => [...deviceQuotaKeys.all, 'details', quyetDinhId] as const,
  compliance: (donViId: number) => [...deviceQuotaKeys.all, 'compliance', donViId] as const,
};

export function useNhomThietBiList(phanLoai?: 'A' | 'B') {
  return useQuery({
    queryKey: deviceQuotaKeys.categories(phanLoai),
    queryFn: () => callRpc({
      fn: 'dinh_muc_nhom_thiet_bi_list',
      args: { p_phan_loai: phanLoai }
    }),
  });
}

export function useQuyetDinhList(trangThai?: string) {
  const { donViId } = useSession();

  return useQuery({
    queryKey: deviceQuotaKeys.decisions(donViId!, trangThai),
    queryFn: () => callRpc({
      fn: 'dinh_muc_quyet_dinh_list',
      args: { p_trang_thai: trangThai }
    }),
    enabled: !!donViId,
  });
}

export function useChiTietList(quyetDinhId: number) {
  return useQuery({
    queryKey: deviceQuotaKeys.details(quyetDinhId),
    queryFn: () => callRpc({
      fn: 'dinh_muc_chi_tiet_list',
      args: { p_quyet_dinh_id: quyetDinhId }
    }),
    enabled: !!quyetDinhId,
  });
}

export function useComplianceReport() {
  const { donViId } = useSession();

  return useQuery({
    queryKey: deviceQuotaKeys.compliance(donViId!),
    queryFn: () => callRpc({
      fn: 'dinh_muc_bao_cao_tuan_thu',
      args: {}
    }),
    enabled: !!donViId,
  });
}

export function useCreateQuyetDinh() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (data: CreateQuyetDinhInput) =>
      callRpc({ fn: 'dinh_muc_quyet_dinh_create', args: data }),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: deviceQuotaKeys.all });
    },
  });
}

export function useActivateQuyetDinh() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (id: number) =>
      callRpc({ fn: 'dinh_muc_quyet_dinh_activate', args: { p_id: id } }),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: deviceQuotaKeys.all });
    },
  });
}

export function usePublishQuyetDinh() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (id: number) =>
      callRpc({ fn: 'dinh_muc_quyet_dinh_publish', args: { p_id: id } }),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: deviceQuotaKeys.all });
    },
  });
}
```

---

## Phase 6: Seed Data

Create migration for official equipment category hierarchy:

```sql
-- Seed Group A: Thiết bị y tế chuyên dùng đặc thù
INSERT INTO nhom_thiet_bi_dinh_muc (ma_nhom, ten_nhom, ten_nhom_en, loai_cap, phan_loai, thu_tu) VALUES
('I', 'Thiết bị y tế chuyên dùng đặc thù', 'Specific Specialized Medical Equipment', 'cap_nhom', 'A', 1);

-- Get the parent ID for Group I
WITH parent AS (SELECT id FROM nhom_thiet_bi_dinh_muc WHERE ma_nhom = 'I' AND phan_loai = 'A')
INSERT INTO nhom_thiet_bi_dinh_muc (parent_id, ma_nhom, ten_nhom, ten_nhom_en, loai_cap, phan_loai, thu_tu)
SELECT id, 'A', 'Chẩn đoán hình ảnh', 'Imaging', 'cap_hang_muc', 'A', 1 FROM parent
UNION ALL SELECT id, 'B', 'Xét nghiệm', 'Laboratory', 'cap_hang_muc', 'A', 2 FROM parent
UNION ALL SELECT id, 'C', 'Hồi sức & Phẫu thuật', 'ICU & Surgery', 'cap_hang_muc', 'A', 3 FROM parent
UNION ALL SELECT id, 'D', 'Chuyên khoa lẻ', 'Specialty Departments', 'cap_hang_muc', 'A', 4 FROM parent;

-- Insert equipment items under each category (example for Imaging)
WITH category AS (
  SELECT id FROM nhom_thiet_bi_dinh_muc
  WHERE ma_nhom = 'A' AND loai_cap = 'cap_hang_muc' AND phan_loai = 'A'
)
INSERT INTO nhom_thiet_bi_dinh_muc (parent_id, ma_nhom, ten_nhom, ten_nhom_en, loai_cap, phan_loai, thu_tu, is_leaf, don_vi_tinh)
SELECT id, '1', 'Hệ thống chụp cắt lớp vi tính', 'CT Scanner System', 'cap_thiet_bi', 'A', 1, true, 'Hệ thống' FROM category
UNION ALL SELECT id, '2', 'Hệ thống chụp cộng hưởng từ', 'MRI System', 'cap_thiet_bi', 'A', 2, true, 'Hệ thống' FROM category
UNION ALL SELECT id, '3', 'Hệ thống chụp mạch số hóa xóa nền', 'DSA System', 'cap_thiet_bi', 'A', 3, true, 'Hệ thống' FROM category
UNION ALL SELECT id, '4', 'Máy X-quang kỹ thuật số chụp tổng quát', 'General Digital X-Ray', 'cap_thiet_bi', 'A', 4, true, 'Cái' FROM category
UNION ALL SELECT id, '5', 'Máy X-quang di động', 'Mobile X-Ray', 'cap_thiet_bi', 'A', 5, true, 'Cái' FROM category
UNION ALL SELECT id, '6', 'Máy X-quang C-Arm', 'C-Arm X-Ray', 'cap_thiet_bi', 'A', 6, true, 'Cái' FROM category
UNION ALL SELECT id, '7', 'Máy chụp X-quang răng toàn cảnh', 'Panoramic Dental X-Ray', 'cap_thiet_bi', 'A', 7, true, 'Cái' FROM category
UNION ALL SELECT id, '8', 'Máy siêu âm chuyên tim mạch', 'Cardiac Ultrasound', 'cap_thiet_bi', 'A', 8, true, 'Cái' FROM category
UNION ALL SELECT id, '9', 'Máy siêu âm tổng quát', 'General Ultrasound', 'cap_thiet_bi', 'A', 9, true, 'Cái' FROM category;

-- Continue for other categories (B, C, D) and Group II...
```

---

## Implementation Checklist

### Database (Priority 1)
- [ ] Create `nhom_thiet_bi_dinh_muc` table with ltree
- [ ] Create `quyet_dinh_dinh_muc` table with immutability trigger
- [ ] Create `chi_tiet_dinh_muc` table with tenant isolation
- [ ] Create `lich_su_dinh_muc` append-only audit table
- [ ] Add `nhom_dinh_muc_id` to `thiet_bi` table
- [ ] Create `v_so_sanh_dinh_muc` view
- [ ] Seed equipment categories

### RPC Functions (Priority 2)
- [ ] `dinh_muc_nhom_thiet_bi_list` - Category tree
- [ ] `dinh_muc_quyet_dinh_list` - List decisions
- [ ] `dinh_muc_quyet_dinh_create` - Create decision
- [ ] `dinh_muc_quyet_dinh_activate` - Activate decision
- [ ] `dinh_muc_quyet_dinh_publish` - Mark as public
- [ ] `dinh_muc_chi_tiet_upsert` - Add/update line items
- [ ] `dinh_muc_chi_tiet_list` - List details
- [ ] `dinh_muc_bao_cao_tuan_thu` - Compliance report

### API Layer (Priority 3)
- [ ] Add functions to `ALLOWED_FUNCTIONS` whitelist
- [ ] Add TypeScript types
- [ ] Create TanStack Query hooks

### UI (Priority 4)
- [ ] Quota decision list page
- [ ] Decision create/edit dialog
- [ ] Tree-table for equipment categories
- [ ] Line item management
- [ ] Compliance dashboard
- [ ] PDF export for Ministry portal

---

## Security Considerations (From Backend Security Review)

1. **Immutability**: Published decisions cannot be modified (enforced by trigger)
2. **Audit Trail**: All changes logged with user info and timestamps
3. **Tenant Isolation**: All functions enforce `don_vi_id` from JWT claims
4. **Role-Based Access**:
   - `global/admin`: Full access across tenants
   - `regional_leader`: Read-only, multi-tenant
   - `to_qltb`: Full CRUD for own tenant
   - Others: Read-only for own tenant
5. **Input Validation**: CHECK constraints on enums, positive quantities

---

## References

- [Knowledge Base](./device-quota-knowledge-2025.md)
- [Circular 46/2025/TT-BYT](https://notebooklm.google.com/notebook/a6de7cf9-ba0d-42e4-8d39-2f4a668add48)
- [Project CLAUDE.md](../../CLAUDE.md) - Security architecture
