# Session Snapshot — 2025-09-15

## Overview
- Adopted a no-RLS, RPC-only multi-tenant architecture enforced in SQL.
- Implemented a secure server-side RPC gateway that signs short-lived JWTs with claims (`app_role`, `don_vi`, `user_id`).
- Removed client-side “auto department filter” to avoid hiding tenant-bypassing roles (e.g., `global`).
- Refactored Equipment and Repair Requests flows to use the RPC gateway; fixed compile errors in Repairs page.
- Added domain RPCs (repairs/transfers/maintenance) and whitelisted them in the gateway.

## Backend (SQL/RPC)
- Claims handling: functions read `COALESCE(app_role, role)` and `don_vi` from JWT claims (compat for client/apikey).
- Equipment RPCs (existing): `equipment_list/get/create/update/delete`, plus `equipment_count`, `equipment_attention_list`.
- New ops RPCs (created today):
  - Repairs: `repair_request_list/get/create/update/delete/approve/complete`
  - Transfers: `transfer_request_list/update_status/delete`
  - Maintenance: `maintenance_tasks_list/bulk_insert/task_update/maintenance_tasks_delete`
- File: `supabase/migrations/20250915_ops_rpcs.sql` (idempotent, SECURITY DEFINER, EXECUTE for `authenticated`).

## RPC Gateway (Next.js API)
- Route: `src/app/api/rpc/[fn]/route.ts` signs JWT with `SUPABASE_JWT_SECRET` and forwards to PostgREST.
- Whitelist updated to include repairs/transfers/maintenance RPCs.
- Token uses `role=authenticated` and application-level `app_role` (from NextAuth session) for SQL checks.

## Frontend Refactors
- Equipment page: Removed auto department banner/logic; unified cache key; continues to use `equipment_list` via gateway.
- Repairs page: Removed auto filter; switched list/create/update/approve/complete/delete to corresponding RPCs.
  - Fixed syntax and `callRpc` signature to use `{ fn, args }` form; compile errors resolved.
  - Some equipment status/history writes still use direct table operations (to be moved into RPCs later).

## Current Status
- Type check passes; repairs page syntax fixed locally.
- Gateway in place; equipment KPIs previously validated via RPCs; repairs now routed via RPCs for core actions.
- Auto department filter removed where it caused `global` visibility issues.

## Next Steps
1) Transfers: refactor to use `transfer_request_list/update_status/delete` via gateway.
2) Maintenance: refactor task CRUD to use `maintenance_*` RPCs via gateway.
3) Repairs hardening: move equipment status/history updates into SQL RPCs for atomicity and consistency.
4) Apply migrations and smoke test tenant scoping with `global` vs tenant roles.
5) Consider export/other domains to route through gateway for uniform security.

## Env/Config
- Required: `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, `SUPABASE_JWT_SECRET`.
- Claims source: NextAuth session includes `role` and `don_vi`; gateway injects them into JWT.

## Notes
- No RLS by design; all access controlled through SECURITY DEFINER RPCs and claims-based SQL checks.
- Avoid UI-side filtering that could hide data for bypass roles; let SQL enforce scoping.

---

## Final Updates (End of Session)
- Repairs list RPC now embeds equipment data: `supabase/migrations/20250915_repairs_list_with_equipment.sql` changes `repair_request_list` to return `setof jsonb` with `thiet_bi` (ten_thiet_bi, ma_thiet_bi, model, serial, khoa_phong_quan_ly).
- UI fix: `src/app/(app)/repair-requests/page.tsx` maps `row.thiet_bi` and displays device name/mã correctly; removed department-based placeholder/messages so UI doesn’t imply client-side filtering.
- Claims type fix already present: `supabase/migrations/20250915_repairs_claims_type_fix.sql` casts JWT `don_vi` to BIGINT across Repairs RPCs.

Status: The DB migration `20250915_repairs_list_with_equipment.sql` has been applied in the current environment.

## Pending / Remaining Tasks
1. Smoke test Repairs page across roles and tenants (global, to_qltb, technician, user): list/search/create/update/approve/complete/delete.
2. Verify RPC proxy allow-list still includes all `repair_request_*` and `equipment_*` functions.
3. Optional: add lightweight e2e for “create/approve/complete” repair flow.

## Quick Restore (New machine)
1. Prereqs: Node 18+, pnpm/npm, Supabase CLI (if using local db ops).
2. Install deps: `npm ci`
3. Env vars: ensure NEXTAUTH + Supabase vars (`NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`, `SUPABASE_JWT_SECRET`).
4. DB: `supabase db push` (or apply migrations manually in your Postgres).
5. Dev: `npm run dev` (or `npm run dev-https`), login, test Repairs page.

## Working Context (for AI agents)
- Architecture: Next.js 15 + NextAuth; Supabase PostgREST; RPC-only via server gateway signing JWT with `app_role` + `don_vi`; SECURITY DEFINER SQL enforces tenant.
- Key files: `src/app/api/rpc/[fn]/route.ts`, `src/app/(app)/repair-requests/page.tsx`, `supabase/migrations/*.sql`.
- Conventions: role strings lowercase; tenant checks via `_get_jwt_claim`/JWT claims; avoid dynamic SQL; whitelist sorts.
