# Tri thức cần nắm vững
Để cô đọng tất cả tri thức từ các nguồn liên quan đến việc xây dựng tiêu chuẩn, định mức trang thiết bị trong các cơ sở y tế và tuân thủ các văn bản quy phạm pháp luật của Việt Nam, tôi xin cung cấp cấu trúc JSON dưới đây:

{
  "TieuChuan_DinhMuc_TrangThietBiYTe": {
    "KhungPhapLyChung": {
      "LuatQuanLySuDungTaiSanCong2017": {
        "SoHieu": "15/2017/QH14",
        "HieuLuc": "01/01/2018",
        "NguyentacApDung": "Mọi tài sản công phục vụ hoạt động quản lý, cung cấp dịch vụ công, bảo đảm quốc phòng, an ninh phải được sử dụng tiết kiệm, hiệu quả, đúng mục đích, công năng, đối tượng, tiêu chuẩn, định mức, chế độ theo quy định của pháp luật.",
        "DinhNghiaTieuChuanDinhMuc": "Quy định về chủng loại, số lượng, mức giá, đối tượng được sử dụng do cơ quan, người có thẩm quyền ban hành. Mức giá đã bao gồm các loại thuế phải nộp.",
        "MucDichDinhMuc": "Làm căn cứ để lập kế hoạch và dự toán ngân sách; giao, đầu tư xây dựng, mua sắm, thuê, khoán kinh phí sử dụng tài sản công; quản lý, sử dụng và xử lý tài sản công.",
        "ThamQuyenBanHanhDinhMuc": {
          "ChinhPhu": "Quy định tiêu chuẩn, định mức sử dụng đối với Trụ sở làm việc, cơ sở hoạt động sự nghiệp; Xe ô tô; Tài sản công của cơ quan Việt Nam ở nước ngoài.",
          "ThuTuongChinhPhu": "Quy định tiêu chuẩn, định mức đối với Tài sản đặc biệt tại đơn vị lực lượng vũ trang nhân dân; Nhà ở công vụ; Máy móc, thiết bị và các loại tài sản công được sử dụng phổ biến tại cơ quan, tổ chức, đơn vị."
        },
        "TaiSanCongTaiCoQuanDonVi": "Bao gồm nhà làm việc, công trình sự nghiệp, quyền sử dụng đất, xe ô tô, phương tiện vận tải, máy móc, thiết bị, quyền sở hữu trí tuệ, phần mềm ứng dụng, cơ sở dữ liệu và tài sản khác."
      },
      "QuanLyTrangThietBiYTe": {
        "NghiDinh98_2021_NDCP": {
          "SoHieu": "98/2021/NĐ-CP",
          "NgayBanHanh": "08-11-2021",
          "HieuLuc": "01-01-2022",
          "PhanLoaiRuiRo": "Phân TBYT thành 4 loại (A, B, C, D) dựa trên mức độ rủi ro tiềm ẩn liên quan đến thiết kế kỹ thuật và sản xuất.",
          "CacLoai": [
            {"Loai": "A", "MucDoRuiRo": "Thấp"},
            {"Loai": "B", "MucDoRuiRo": "Trung bình thấp"},
            {"Loai": "C", "MucDoRuiRo": "Trung bình cao"},
            {"Loai": "D", "MucDoRuiRo": "Cao"}
          ],
          "NguyentacPhanLoai": "Dựa trên cơ sở quy tắc phân loại về mức độ rủi ro; áp dụng mức rủi ro cao nhất nếu có nhiều mức độ rủi ro hoặc mục đích sử dụng khác nhau. Mỗi TBYT sử dụng kết hợp với TBYT khác phải được phân loại rủi ro riêng biệt."
        }
      }
    },
    "DinhMucSuDungTaiSanYTeChuyenDung": {
      "ThongTu08_2019_TTBYT": {
        "SoHieu": "08/2019/TT-BYT",
        "NgayBanHanh": "31/05/2019",
        "HieuLuc": "01/08/2019",
        "PhanLoaiTBYTChuyenDung": [
          "Trang thiết bị y tế chuyên dùng đặc thù",
          "Trang thiết bị y tế chuyên dùng khác"
        ],
        "DieuKienDinhMucSuDungTBYTChuyenDungKhac": [
          "Chức năng, nhiệm vụ, quyền hạn được cấp có thẩm quyền phê duyệt.",
          "Cơ cấu tổ chức, quy mô hoạt động (đối với cơ sở KCB: phạm vi hoạt động chuyên môn, số lượng giường bệnh thực tế).",
          "Điều kiện cơ sở vật chất và nhân lực để lắp đặt và sử dụng.",
          "Số lượng, tần suất sử dụng hiện có và dự kiến nhu cầu sử dụng trong 03 năm tiếp theo."
        ],
        "QuyTrinhPheDuyetDinhMuc": "Người đứng đầu đơn vị sự nghiệp y tế xây dựng hồ sơ và trình cấp có thẩm quyền phê duyệt; trường hợp yêu cầu sử dụng TBYT đặc thù vượt định mức phải có ý kiến thống nhất bằng văn bản của Bộ Y tế.",
        "XuLyVuotDinhMuc": "Trường hợp TBYT chuyên dùng đã trang bị trước ngày Thông tư 08/2019/TT-BYT có hiệu lực mà vượt định mức, đơn vị phải báo cáo cơ quan có thẩm quyền để xem xét quyết định hình thức xử lý theo quy định tại Nghị định 151/2017/NĐ-CP.",
        "ViDuDinhMucTBYTChuyenDungDacThu": [
          {"ChungLoai": "Máy X quang kỹ thuật số chụp tổng quát", "DinhMuc": "Tối đa 01 máy/cơ sở (nhu cầu < 300 ca/tháng); tối đa 02 máy/cơ sở (nhu cầu 300 - 2600 ca/tháng). Bổ sung máy nếu công suất TB > 1300 ca/tháng/máy."},
          {"ChungLoai": "Máy siêu âm chuyên tim mạch", "DinhMuc": "Tối đa 01 máy/đơn vị (nhu cầu ≤ 300 ca/tháng). Bổ sung nếu công suất TB > 300 ca/tháng/máy; 01 máy/Phòng DSA/Đơn vị hồi sức tim mạch."},
          {"ChungLoai": "Máy thở", "DinhMuc": "Tối đa 01 máy/giường hồi sức sau phẫu thuật/hồi sức tích cực/cấp cứu. Dự phòng 01 máy/ 06 máy."},
          {"ChungLoai": "Máy gây mê", "DinhMuc": "01 máy/ bàn mổ. Dự phòng 01 máy/ 06 máy."},
          {"ChungLoai": "Bơm tiêm điện", "DinhMuc": "Tối thiểu 01 cái/ bàn mổ/ giường Hồi tỉnh. Tối đa 05 cái/ giường Hồi sức/ Cấp cứu."}
        ]
      },
      "DinhMucThucTeTheoDiaPhuong": {
        "QuyetDinh60_2023_QDUBND_KonTum": "Ban hành tiêu chuẩn, định mức sử dụng máy móc, thiết bị chuyên dùng thuộc lĩnh vực y tế cho các cơ sở y tế tại Tỉnh Kon Tum, bao gồm: Bệnh viện Đa khoa Tỉnh, Bệnh viện Đa khoa Khu vực Ngọc Hồi, Trung tâm Kiểm soát Bệnh tật, Trung tâm Giám định Y khoa, Trung tâm Pháp Y, Trung tâm Kiểm nghiệm Thuốc/Mỹ phẩm/Thực phẩm, và các Trung tâm Y tế huyện/thành phố."
      }
    },
    "QuyTrinhMuaSamVaDauThau": {
      "LuatDauThauLinhVucYTe": {
        "LuatDauThau2023": "Đấu thầu vật tư y tế là một mảng trong công tác đấu thầu mua sắm công, phải tuân theo Luật Đấu thầu. Luật Đấu thầu 2023 (số 22/2023/QH15) bổ sung quy định mới nhằm giải quyết khó khăn, vướng mắc trong đấu thầu mua thuốc, hóa chất, vật tư xét nghiệm và thiết bị y tế.",
        "QuyDinhMoiDauThauYTe": [
          "Cơ sở y tế công lập tự quyết định mua thuốc ngoài danh mục thuốc BHYT chi trả, mua vắc xin tiêm chủng dịch vụ.",
          "Cho phép chỉ định thầu để mua thuốc, thiết bị y tế trong trường hợp cấp cứu người bệnh hoặc duy trì hoạt động cấp bách.",
          "Hồ sơ mời thầu được nêu xuất xứ thiết bị y tế từ một nhóm quốc gia cụ thể.",
          "Cho phép áp dụng đàm phán đối với gói thầu mua biệt dược gốc, sinh phẩm tham chiếu; gói thầu mua thuốc, thiết bị y tế, vật tư xét nghiệm chỉ có 01 hoặc 02 hãng sản xuất."
        ],
        "QuyTrinhMuaSamTapTrung": [
          "Xác định khối lượng mua sắm.",
          "Lập, thẩm định và phê duyệt kế hoạch lựa chọn nhà thầu.",
          "Tổ chức lựa chọn nhà thầu (theo trình tự Luật đấu thầu).",
          "Đánh giá hồ sơ dự thầu.",
          "Trình thẩm định, phê duyệt, công khai kết quả lựa chọn nhà thầu và giải thích lý do.",
          "Hoàn thiện, ký kết thỏa thuận khung.",
          "Hoàn thiện, ký kết và thực hiện hợp đồng với nhà thầu trúng thầu.",
          "Quyết toán, thanh lý hợp đồng."
        ]
      },
      "ThanhToanBHYTKyThuatChuanDoanHinhAnh": {
        "ThongTu22_2023_TTBYT": "Quy định định mức thanh toán cho các kỹ thuật chẩn đoán hình ảnh giữa cơ quan BHYT và cơ sở KCB.",
        "DinhMucTinhGiaToiDaTheoCa": "Xác định số ca tối đa được thanh toán dựa trên Định mức tính giá (số ca/máy/ngày làm việc 8 giờ) nhân với các yếu tố thực tế (giờ làm việc, ngày làm việc, số máy hoạt động) và nhân với 120%.",
        "DinhMucChiTiet8GioLamViec": [
          {"DichVu": "Siêu âm", "DinhMuc": "48 ca/máy/ngày"},
          {"DichVu": "Chụp X-quang thường/số hóa", "DinhMuc": "58 ca/máy/ngày"},
          {"DichVu": "Chụp CT Scanner đến 32 dãy", "DinhMuc": "29 ca/máy/ngày"},
          {"DichVu": "Chụp cộng hưởng từ (MRI)", "DinhMuc": "19 ca/máy/ngày"}
        ],
        "XuLyVuotCaToiDa": "Số ca vượt quá mức tối đa sẽ được thanh toán theo mức giá không bao gồm chi phí tiền lương. Ví dụ: Siêu âm 55%, X-quang 85%, CT Scanner 95%, MRI 97% mức giá quy định."
      }
    },
    "TieuChuanQuanLyChatLuong": {
      "ISO13485_2016": {
        "TenTieuChuan": "Hệ thống quản lý Trang thiết bị y tế (ISO 13485:2016)",
        "YeuCauChinh": "Quy định các yêu cầu đối với hệ thống quản lý chất lượng áp dụng tại các cơ sở cung cấp dụng cụ y tế và dịch vụ liên quan, nhằm đảm bảo khả năng cung cấp sản phẩm đáp ứng yêu cầu của khách hàng và các quy định của pháp luật.",
        "BatBuocTheoPhapLuat": "Là yêu cầu bắt buộc theo Nghị định 98/2021/NĐ-CP quản lý trang thiết bị y tế mới nhất tại Việt Nam.",
        "MucDichQuanLy": "Đảm bảo thiết kế nhất quán, phát triển, sản xuất, lắp đặt và phân phối các thiết bị y tế an toàn cho mục đích dự kiến.",
        "CoCau": "Dựa trên mô hình quy trình ISO 9001 (Kế hoạch, Thực hiện, Kiểm tra, Hành động) nhưng mang tính chất quy định và đòi hỏi hệ thống quản lý chất lượng được lập thành văn bản kỹ lưỡng hơn cho môi trường sản xuất TBYT."
      },
      "TieuChuanThuNghiemLamSangQuocTe": {
        "SoSanhQuocGia": "Các tiêu chuẩn thử nghiệm lâm sàng thiết bị y tế có sự khác biệt giữa các khu vực:",
        "HoaKy": "Quy định bởi FDA, yêu cầu nghiên cứu lâm sàng để chứng minh tính an toàn và hiệu quả, nhấn mạnh tính minh bạch trong báo cáo.",
        "LienMinhChauAu": "Quy định bởi Quy chế về thiết bị y tế (MDR), yêu cầu nghiêm ngặt tương tự, nhấn mạnh sự tham gia của các bên thứ ba độc lập trong việc đánh giá và xác nhận kết quả thử nghiệm.",
        "NhatBan": "Quản lý bởi PMDA, tập trung vào việc xây dựng dữ liệu lâm sàng trước khi thị trường hóa, tối ưu hóa quy trình thử nghiệm để rút ngắn thời gian đưa sản phẩm ra thị trường."
      }
    }
  }
}


# Kế hoạch triển khai chức năng theo dõi định mức thiết bị cho ứng dụng hiện tại

## 1. Bối cảnh & mục tiêu
- Hệ thống hiện quản lý vận hành thiết bị y tế đa đơn vị (multi-tenant) nhưng chưa có cơ chế chuẩn để so sánh số lượng thiết bị với định mức được cơ quan có thẩm quyền phê duyệt.
- Pháp lý nền tảng: Luật Quản lý, sử dụng tài sản công; Nghị định/Thông tư hướng dẫn (đặc biệt Thông tư 08/2019/TT-BYT cho trang thiết bị y tế). Các tiêu chuẩn định mức quy định rõ chủng loại, số lượng tối đa/mức giá và quy trình phê duyệt khi vượt chuẩn.
- Mục tiêu: cung cấp cho từng đơn vị khả năng nhập, duy trì định mức được phê duyệt, so sánh tự động với thực tế, cảnh báo vượt chuẩn, hỗ trợ quy trình xin vượt định mức và báo cáo kiểm tra tuân thủ.

## 2. Nguyên tắc & giả định thiết kế
- **Tuân thủ vai trò & luận cứ pháp lý**: chỉ người có thẩm quyền mới cập nhật định mức; đơn vị thường chỉ xem, tự kiểm tra và lập đề nghị vượt định mức.
- **Multi-tenant an toàn**: tất cả RPC/API phải nhận `p_don_vi`, xác định lại từ JWT đối với người không phải `global`.
- **Lưu vết đầy đủ**: mọi thay đổi định mức, lần kiểm tra, đề nghị vượt chuẩn đều phải có lịch sử phục vụ kiểm toán.
- **Idempotent migrations**: SQL Supabase phải kiểm tra tồn tại trước khi tạo/sửa.
- **Khả năng mở rộng**: kiến trúc cho phép thêm tiêu chí tính toán (ví dụ số giường bệnh) mà không đụng vào dữ liệu lịch sử.

## 3. Phạm vi & yêu cầu nghiệp vụ
| Hạng mục | Mô tả nghiệp vụ | Nhóm người dùng |
|----------|-----------------|-----------------|
| Quản lý định mức | Nhập định mức cho từng loại thiết bị theo đơn vị/khoa phòng, lưu hồ sơ phê duyệt, ngày hiệu lực | Quản trị cấp bộ, quản trị đơn vị có thẩm quyền |
| Theo dõi tuân thủ | So sánh real-time số lượng thiết bị thực tế vs định mức, trạng thái "Đạt/Thiếu/Vượt" | Toàn bộ đơn vị, đặc biệt quản trị khoa phòng |
| Quy trình vượt định mức | Đơn vị tạo đề nghị vượt chuẩn kèm lý do, tài liệu; luồng duyệt nhiều cấp | Đơn vị đề xuất, cấp duyệt |
| Kiểm tra & tự kiểm tra | Lập biên bản kiểm tra, checklist tuân thủ, ghi nhận xử lý vi phạm | Cơ quan kiểm tra, đơn vị |
| Báo cáo & xuất khẩu | Dashboard, export Excel/PDF tổng hợp định mức, vượt chuẩn, lịch sử kiểm tra | Cấp lãnh đạo |

Không nằm trong phạm vi giai đoạn đầu: tự động tính định mức dựa trên số giường bệnh; tích hợp thẳng với hệ thống văn bản điều hành.

## 4. Thiết kế dữ liệu & migrations (Supabase Postgres)
### 4.1 Danh mục loại thiết bị chuẩn
- Bảng `public.thiet_bi_chuan_loai`: `id`, `ma_loai`, `ten_loai`, `mo_ta`, `nhom` (đặc thù/khác), `phan_loai_phap_ly`, `created_at`, `updated_at`.
- Mapping sang thiết bị thực tế: thêm cột `chuan_loai_id` (FK) cho bảng `thiet_bi`, cập nhật dữ liệu hiện có bằng script bán tự động hoặc qualy mapping.

### 4.2 Cấu trúc cây nhóm định mức
- Bảng `public.thiet_bi_dinh_muc_nhom` để biểu diễn cấu trúc giống tài liệu tham khảo (cấp cơ sở → nhóm → hạng mục → tiểu hạng mục):
  - `id` (PK), `don_vi_id` (FK `don_vi`), `parent_id` (FK self-reference, NULL cho cấp gốc), `ten_nhom`, `loai_cap` (`cap_co_so`, `cap_nhom`, `cap_hang_muc`, `cap_tieu_hang_muc`...), `thu_tu_hien_thi` (INT), `ma_stt_hien_thi` (TEXT, ví dụ “I”, “A”, “1”, “a”), `ghi_chu`, timestamps, `created_by`, `updated_by`.
  - Cho phép một đơn vị có nhiều cây nhóm; có thể reuse cho các cơ sở khác bằng cách copy tree mẫu.

### 4.3 Định mức chi tiết theo hạng mục
- Bảng `public.thiet_bi_dinh_muc_chi_tiet`:
  - `id` (PK), `don_vi_id`, `nhom_id` (FK tới `thiet_bi_dinh_muc_nhom`, yêu cầu node lá), `chuan_loai_id` (nullable), `pham_vi` (ENUM `toan_don_vi`/`khoa_phong`/`du_an`), `khoa_phong` (TEXT nullable),
  - `don_vi_tinh` (TEXT), `so_luong_dinh_muc` (NUMERIC), `so_luong_toi_thieu` (NUMERIC optional), `gia_tri_toi_da` (NUMERIC optional), `so_van_ban_phe_duyet`, `ngay_hieu_luc`, `ngay_het_han` (nullable), `trang_thai` (`hieu_luc`/`het_hieu_luc`/`cho_duyet`), `ghi_chu`, `created_by`, `updated_by`, timestamps.
  - Constraint duy nhất: không trùng `don_vi_id + nhom_id + COALESCE(khoa_phong,'__all__') + trang_thai=hieu_luc`.
  - Nếu cần lưu định mức tổng ở cấp nhóm (ví dụ “Hệ thống CT – Scanner” trước khi phân nhánh a/b/c), thêm cột `allow_group_quota BOOLEAN DEFAULT FALSE` và cho phép `nhom_id` không phải leaf khi flag bật.

### 4.4 Lịch sử thay đổi định mức
- Bảng `public.thiet_bi_dinh_muc_lich_su`: `id`, `chi_tiet_id`, `snapshot JSONB`, `thao_tac` (`tao`, `cap_nhat`, `huy`), `thuc_hien_boi`, `ly_do`, `thoi_diem`.

### 4.5 Đề nghị vượt định mức & luồng duyệt
- Bảng `public.de_nghi_vuot_dinh_muc`: `id`, `don_vi_id`, `nhom_id`, `chuan_loai_id`, `so_luong_hien_co`, `muc_dinh_de_xuat`, `ly_do`, `tai_lieu_dinh_kem` (JSONB danh sách file), `trang_thai` (`dang_xu_ly`, `da_duyet`, `tu_choi`), `nguoi_tao`, `created_at`, `nguoi_duyet`, `ngay_duyet`, `comment_duyet`.
- Bảng `public.de_nghi_vuot_dinh_muc_flow` (tùy chọn) để lưu các bước phê duyệt: `id`, `de_nghi_id`, `buoc_thu_tu`, `role_duyet`, `trang_thai`, `nguoi_thuc_hien`, `thoi_gian`, `nhan_xet`.

### 4.6 Biên bản kiểm tra định mức
- Bảng `public.kiem_tra_dinh_muc`: `id`, `don_vi_id`, `thoi_gian`, `co_quan_kiem_tra`, `ket_luan_chung`, `hanh_dong_khien_nghi` (JSONB), `tep_dinh_kem`, `created_by`, timestamps.
- Bảng `public.kiem_tra_dinh_muc_chi_tiet`: `id`, `kiem_tra_id`, `nhom_id`, `ket_qua` (`dat`, `khong_dat`, `vuot`), `so_luong_thuc_te`, `ghi_chu`.

### 4.7 View/materialized view hỗ trợ báo cáo
- View `vw_thiet_bi_dinh_muc_cay`: flatten tree kèm cấp độ để render bảng giống tài liệu (cột STT, tên, đơn vị tính, số lượng, ghi chú).
- View `vw_thiet_bi_vs_dinh_muc`: join `thiet_bi`, `thiet_bi_dinh_muc_chi_tiet`, (optionally) `thiet_bi_chuan_loai` để tính số lượng thực tế/hạn mức.
- Materialized view `mv_thiet_bi_dinh_muc_status` (tùy chọn) cho dashboard, refresh qua Supabase cron.

## 5. RPC/API cần phát triển
- `public.equipment_quota_tree(p_don_vi BIGINT)` → trả cấu trúc cây nhóm & chi tiết định mức (dùng view `vw_thiet_bi_dinh_muc_cay`).
- `public.equipment_quota_status(p_don_vi BIGINT, p_khoa_phong TEXT DEFAULT NULL)` → so sánh số lượng thực tế (`thiet_bi`) với định mức, trả `status` (`thieu`, `dat`, `vuot`), `ty_le`, danh sách thiết bị vượt, cho phép lọc theo node/hạng mục.
- `public.equipment_quota_upsert(p_payload JSONB)` → CRUD cho bảng `thiet_bi_dinh_muc_chi_tiet`, ghi lịch sử.
- `public.equipment_quota_group_upsert(p_payload JSONB)` → CRUD cho bảng `thiet_bi_dinh_muc_nhom` (xây/điều chỉnh cây).
- `public.equipment_quota_audit_log(p_don_vi BIGINT)` → trả log kiểm tra & kết luận.
- `public.equipment_quota_exception_request(p_payload JSONB)` và `public.equipment_quota_exception_approve(p_id, p_action, p_comment)`.

Các RPC phải áp dụng mẫu bảo mật hiện có (`_get_jwt_claim`, đảm bảo tenant & role). API proxy Next.js `/api/rpc/equipment-quota/*` ánh xạ tương ứng, dùng React Query hooks để fetch/update.

## 6. Giao diện người dùng (Next.js + Tailwind + Radix)
1. **Dashboard định mức**
   - Widget tổng quan: % đạt định mức theo nhóm chính, số nhóm vượt chuẩn, số đề nghị đang chờ.
   - Biểu đồ thanh so sánh `thuc_te` vs `dinh_muc` theo hạng mục.

2. **Trang chi tiết theo dõi** (`/app/equipment/quotas`)
   - Tree-table hiển thị cấu trúc (I → A → 1 → a) giống tài liệu, cột đơn vị tính, định mức, thực tế, chênh lệch, trạng thái, ghi chú.
   - Bộ lọc: tenant (chỉ global), khoa phòng, nhóm thiết bị, trạng thái.
   - Tooltip hiển thị căn cứ pháp lý (trích lược Thông tư/Nghị định tương ứng).

3. **Trang quản trị định mức & cấu trúc**
   - Tab "Cấu trúc" để thêm/sắp xếp node (drag & drop hoặc form), nhập `ma_stt_hien_thi` để giữ thứ tự I/A/1/a.
   - Tab "Định mức" để CRUD `thiet_bi_dinh_muc_chi_tiet`, upload văn bản phê duyệt, đặt hiệu lực.
   - Chỉ mở cho roles: `global`, `to_qltb` hoặc role do config.

4. **Luồng đề nghị vượt định mức**
   - Modal/wizard: chọn hạng mục (node lá), hiển thị định mức & thực tế hiện tại, nhập số đề nghị, lý do, đính kèm minh chứng.
   - Trang duyệt: danh sách đề nghị (table), chi tiết, nút phê duyệt/từ chối, ghi chú; hiển thị timeline flow nếu nhiều bước.

5. **Trang/Modal kiểm tra định mức**
   - Form ghi biên bản, checklist per hạng mục (đạt/không đạt/vượt), biện pháp xử lý.
   - Cho phép xuất PDF/Excel biên bản từ UI (dùng client export hoặc server render).

6. **Khả năng truy cập & phản hồi**
   - Sử dụng `@tanstack/react-query` cho dữ liệu bất đồng bộ, đảm bảo trạng thái loading/empty/error.
   - Thêm cảnh báo màu (Radix `AlertDialog`, `Badge`); highlight node vượt chuẩn.

## 7. Quy trình nghiệp vụ & tích hợp
- **Cập nhật định mức**: cấp thẩm quyền nhập → hệ thống lưu phiên bản mới, gắn ngày hiệu lực, vô hiệu bản cũ.
- **Theo dõi tự động**: cron job (hoặc hook) refresh view; UI gọi RPC cập nhật sau mỗi biến động `thiet_bi` (create/update/delete).
- **Đề nghị vượt**: khi phát hiện `status = vuot/thieu`: 
  1. Đơn vị tạo đề nghị (`dang_xu_ly`).
  2. Cấp duyệt nhận thông báo (notification/email webhook).
  3. Phê duyệt → cập nhật định mức hoặc tạo nhiệm vụ xử lý.
- **Kiểm tra định kỳ**: lên lịch (cron table) và hiển thị nhắc nhở trong dashboard.

## 8. Báo cáo & xuất khẩu
- Báo cáo PDF/Excel: tổng hợp định mức theo đơn vị, thiết bị, số lần vượt, số đề nghị đang chờ.
- API export tái sử dụng pipeline `reports-export-*` hiện có.
- Tạo preset "Tuân thủ định mức" trong hệ thống báo cáo sử dụng view `vw_thiet_bi_dinh_muc_cay` + `vw_thiet_bi_vs_dinh_muc`.

## 9. Phân quyền & bảo mật
- Roles đề xuất:
  - `global`: xem & chỉnh mọi tenant.
  - `to_qltb` (quản lý thiết bị): chỉnh định mức & cấu trúc trong đơn vị, duyệt đề nghị cấp dưới.
  - `technician`, `user`: chỉ xem dashboard, gửi đề nghị (nếu được ủy quyền).
- RPC kiểm tra `v_role`; chặn sửa/xem trái phép.
- Front-end middleware dựa trên session (NextAuth) ẩn menu với role không hợp lệ.
- Audit log: tận dụng `thiet_bi_dinh_muc_lich_su`, `de_nghi_vuot_dinh_muc_flow`, log Supabase (pg audit nếu cần).

## 10. Kiểm thử & bảo đảm chất lượng
- **Unit test RPC**: pgTAP hoặc script SQL -> test trạng thái `dat/vuot/thieu`, filter tenant, vai trò, node tree.
- **Integration test**: Next.js route handler ↔ Supabase RPC (mock client) cho các case chính.
- **UI test**: Testing Library/Playwright cho tree-table, CRUD, flow duyệt.
- **Data migration validation**: script thống kê mapping loại thiết bị; đánh dấu thiết bị chưa phân loại; import CSV mẫu từ bảng chuẩn.

## 11. Lộ trình triển khai đề xuất
1. **Giai đoạn 0 – Chuẩn bị (1 sprint)**
   - Xác nhận taxonomy loại thiết bị và format dữ liệu đầu vào (dựa trên bảng chuẩn như ảnh).
   - Soạn migration skeleton, kiểm thử tại Supabase dev.
   - Thống nhất vai trò, quy trình duyệt với stakeholder.

2. **Giai đoạn 1 – Backend & dữ liệu (1-2 sprint)**
   - Triển khai migrations `thiet_bi_chuan_loai`, `thiet_bi_dinh_muc_nhom`, `thiet_bi_dinh_muc_chi_tiet`, lịch sử.
   - Seed cây nhóm mẫu (ví dụ Bệnh viện đa khoa) qua script import CSV.
   - Viết RPC `equipment_quota_*`, test sơ bộ.

3. **Giai đoạn 2 – Giao diện & trải nghiệm (1-2 sprint)**
   - Build dashboard & trang tree-table.
   - Tạo form CRUD cấu trúc + định mức, flow đề nghị vượt.
   - Bổ sung thông báo (toast/email stub).

4. **Giai đoạn 3 – Kiểm thử, tài liệu & triển khai (1 sprint)**
   - Viết tài liệu hướng dẫn, cập nhật docs.
   - Hoàn thiện manual test plan, chạy UAT với 1-2 đơn vị pilot.
   - Migrate dữ liệu thực, bàn giao vận hành.

5. **Giai đoạn 4 – Mở rộng & tối ưu (tùy chọn)**
   - Tự động tính định mức theo số giường/công suất.
   - Đồng bộ với hệ thống văn bản điện tử.

## 12. Rủi ro & phương án giảm thiểu
- **Thiếu taxonomy chuẩn** → Workshop với phòng vật tư; cho phép trạng thái "chưa phân loại" kèm cảnh báo.
- **Dữ liệu định mức không đầy đủ** → Hỗ trợ import CSV, cung cấp template theo cấu trúc bảng chuẩn.
- **Thay đổi quy định pháp lý** → Lưu metadata mở rộng (JSONB) để điều chỉnh nhanh.
- **Hiệu năng** → Chỉ mục theo `don_vi`, `nhom_id`; materialized view, cache React Query.
- **Chậm phê duyệt** → Nhắc nhở qua thông báo, badge màu trong dashboard.

## 13. Tài liệu & đào tạo
- Cập nhật `docs/` với hướng dẫn nhập định mức, quy trình vượt chuẩn, checklist tự kiểm tra.
- Chuẩn bị video/slide đào tạo cho quản trị đơn vị.
- Cung cấp template biên bản kiểm tra tải từ hệ thống.

## 14. Phụ lục tham chiếu
- Luật 15/2017/QH14 về quản lý, sử dụng tài sản công.
- Nghị định 151/2017/NĐ-CP, Nghị định 69/2021/NĐ-CP (nếu áp dụng).
- Thông tư 08/2019/TT-BYT – tiêu chuẩn, định mức trang thiết bị y tế.

## 15. Bổ sung tuân thủ pháp lý & best practices

### 15.1 Checklist tuân thủ văn bản quy phạm pháp luật (áp dụng cho định mức thiết bị)
- Nguồn căn cứ: lưu đầy đủ trường meta cho văn bản làm căn cứ định mức/điều chỉnh: `so_ky_hieu`, `trich_yeu`, `co_quan_ban_hanh`, `ngay_ban_hanh`, `ngay_hieu_luc`, `tep_dinh_kem` (file ký số nếu có), `duong_dan_tra_cuu`.
- Phạm vi áp dụng: xác định rõ `don_vi_id`, `pham_vi` (toàn đơn vị/khoa phòng/dự án), thời hạn áp dụng (`effective_from`, `effective_to` hoặc `is_current`).
- Phiên bản hóa: mỗi lần điều chỉnh định mức tạo phiên bản mới, không ghi đè; khóa khoảng thời gian hiệu lực không chồng lấn (constraint EXCLUDE OVERLAPS).
- Lịch sử & kiểm toán: bắt buộc ghi vào `thiet_bi_dinh_muc_lich_su` với `thao_tac`, `thuc_hien_boi`, `ly_do`, `snapshot` trước/sau; không cho phép xóa cứng (soft-delete hoặc vô hiệu bằng `effective_to`).
- Quy trình vượt định mức: hồ sơ đề nghị phải có `so_van_ban_de_nghi`, `ngay_de_nghi`, `file_dinh_kem`; quyết định phê duyệt có `so_quyet_dinh`, `ngay_duyet`, `co_quan_phe_duyet`, `tep_quyet_dinh`.
- Lọc theo tenant/role: tất cả RPC cưỡng chế `don_vi` từ JWT trừ `global`; ghi nhận `user_id` thao tác vào bảng lịch sử.
- Xuất trình/kiểm tra: cung cấp export PDF/XLSX kèm phụ lục trích lược căn cứ pháp lý, dấu thời gian sinh báo cáo.

Tham chiếu chính: Luật 15/2017/QH14; Nghị định 151/2017/NĐ-CP; Thông tư 08/2019/TT-BYT. Khuyến nghị bổ sung hỗ trợ chữ ký số theo Nghị định 130/2018/NĐ-CP (tùy khả năng).

### 15.2 Điều chỉnh dữ liệu & migrations để đáp ứng tuân thủ
- Bảng `thiet_bi_dinh_muc_chi_tiet`:
  - Thêm cột: `effective_from DATE NOT NULL DEFAULT CURRENT_DATE`, `effective_to DATE NULL`, `so_quyet_dinh TEXT NULL`, `co_quan_phe_duyet TEXT NULL`, `tai_lieu_can_cu JSONB NULL` (danh sách {type, so_ky_hieu, url, file_id}).
  - Unique phiên bản: `UNIQUE (don_vi_id, nhom_id, chuan_loai_id, pham_vi, coalesce(khoa_phong,'$ALL$'), effective_from)`.
  - Ràng buộc không chồng lấn: `EXCLUDE USING gist (don_vi_id WITH =, nhom_id WITH =, chuan_loai_id WITH =, pham_vi WITH =, (coalesce(khoa_phong,'$ALL$')) WITH =, daterange(effective_from, coalesce(effective_to,'infinity')) WITH &&)` (cần extension `btree_gist`).
  - Chỉ mục: `(don_vi_id, nhom_id)`, `(don_vi_id, effective_from DESC)`.
- Bảng `thiet_bi_dinh_muc_lich_su`:
  - Bổ sung `before JSONB`, `after JSONB`, `request_id BIGINT NULL` (liên kết đề nghị vượt), `performed_by BIGINT NOT NULL`.
- Bảng `de_nghi_vuot_dinh_muc`:
  - Thêm `so_van_ban_de_nghi TEXT`, `ngay_de_nghi DATE`, `tep_quyet_dinh JSONB`, `so_quyet_dinh TEXT`, `co_quan_phe_duyet TEXT`, `ngay_quyet_dinh DATE`.
- Storage/Files: chuẩn hóa tham chiếu tệp qua `file_id` (bucket Supabase Storage) thay vì chỉ URL; lưu checksum để chống sửa đổi.
- Idempotency: migrations dùng `IF NOT EXISTS`, `ALTER TABLE ... ADD COLUMN IF NOT EXISTS`, `CREATE EXTENSION IF NOT EXISTS btree_gist`.

### 15.3 RPC theo best practices bảo mật/kiểm toán
- Chữ ký hàm: tất cả RPC nhận `p_don_vi BIGINT` nhưng nội bộ thay thế bằng `_get_jwt_claim('don_vi')` nếu người dùng không phải `global`.
- Bổ sung tham số thời gian: `p_as_of DATE DEFAULT CURRENT_DATE` cho `equipment_quota_status` để tính trạng thái tại một ngày bất kỳ (phục vụ kiểm toán).
- `SECURITY DEFINER` + `SET search_path` tường minh; whitelist sort/pagination; `GRANT EXECUTE ON FUNCTION ... TO authenticated`.
- Ghi log: trong `equipment_quota_upsert` và `equipment_quota_group_upsert` ghi `performed_by := _get_jwt_claim('user_id')` vào lịch sử.
- Trả về metadata pháp lý tối thiểu: trong `equipment_quota_tree` và `equipment_quota_status` trả thêm `legal_refs` (rút gọn) để UI hiển thị tooltip căn cứ pháp lý.

### 15.4 Kiểm thử tuân thủ
- Unit test SQL: kiểm tra ràng buộc không chồng lấn hiệu lực, quyền tenant, tính trạng thái `thieu/dat/vuot` theo `p_as_of`.
- Integration test API proxy: xác minh JWT claims không thể override từ client, và RPC chỉ trả dữ liệu trong tenant.
- Kiểm thử xuất báo cáo: so khớp số liệu giữa PDF/XLSX và view SQL tại cùng thời điểm `as_of`.
- Hướng dẫn nội bộ multi-tenant (`docs/multi-tenant-plan.md`).
- Bảng định mức mẫu của Bệnh viện đa khoa (ảnh tham chiếu) – dùng làm template import.

## 15. Công việc tiếp theo ngay lập tức
1. Chốt danh sách nhóm thiết bị ưu tiên và mẫu dữ liệu định mức ban đầu với stakeholder.
2. Lập migration draft để kiểm chứng trên môi trường dev Supabase.
3. Thiết kế wireframe dashboard & tree-table quản trị định mức để review UX.
