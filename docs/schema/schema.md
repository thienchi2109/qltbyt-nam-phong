create table public.thiet_bi (
  ma_thiet_bi text not null,
  ten_thiet_bi text null,
  model text null,
  serial text null,
  cau_hinh_thiet_bi text null,
  phu_kien_kem_theo text null,
  hang_san_xuat text null,
  noi_san_xuat text null,
  nam_san_xuat integer null,
  ngay_nhap text null,
  ngay_dua_vao_su_dung text null,
  nguon_kinh_phi text null,
  gia_goc numeric null,
  nam_tinh_hao_mon integer null,
  ty_le_hao_mon text null,
  han_bao_hanh text null,
  vi_tri_lap_dat text null,
  nguoi_dang_truc_tiep_quan_ly text null,
  khoa_phong_quan_ly text null,
  tinh_trang_hien_tai text null,
  ghi_chu text null,
  chu_ky_bt_dinh_ky integer null,
  ngay_bt_tiep_theo date null,
  chu_ky_hc_dinh_ky integer null,
  ngay_hc_tiep_theo date null,
  chu_ky_kd_dinh_ky integer null,
  ngay_kd_tiep_theo date null,
  phan_loai_theo_nd98 text null,
  id bigint generated by default as identity not null,
  created_at timestamp with time zone not null default now(),
  don_vi bigint null,
  constraint thiet_bi_pkey primary key (id),
  constraint thiet_bi_ma_thiet_bi_key unique (ma_thiet_bi),
  constraint thiet_bi_don_vi_fkey foreign KEY (don_vi) references don_vi (id) on update RESTRICT on delete RESTRICT
) TABLESPACE pg_default;

create index IF not exists idx_thiet_bi_created_at on public.thiet_bi using btree (created_at) TABLESPACE pg_default;

create index IF not exists idx_thiet_bi_search_text on public.thiet_bi using gin (
  (((ten_thiet_bi || ' '::text) || ma_thiet_bi)) extensions.gin_trgm_ops
) TABLESPACE pg_default;

create index IF not exists idx_thiet_bi_ten_thiet_bi_trgm on public.thiet_bi using gin (ten_thiet_bi extensions.gin_trgm_ops) TABLESPACE pg_default;

create index IF not exists idx_thiet_bi_ma_thiet_bi_trgm on public.thiet_bi using gin (ma_thiet_bi extensions.gin_trgm_ops) TABLESPACE pg_default;

create index IF not exists idx_thiet_bi_khoa_phong_quan_ly on public.thiet_bi using btree (khoa_phong_quan_ly) TABLESPACE pg_default;

create index IF not exists idx_thiet_bi_vi_tri_lap_dat on public.thiet_bi using btree (vi_tri_lap_dat) TABLESPACE pg_default;

create index IF not exists idx_thiet_bi_tinh_trang_hien_tai on public.thiet_bi using btree (tinh_trang_hien_tai) TABLESPACE pg_default;

create index IF not exists idx_thiet_bi_dept_status on public.thiet_bi using btree (khoa_phong_quan_ly, tinh_trang_hien_tai) TABLESPACE pg_default;

create index IF not exists idx_thiet_bi_location_status on public.thiet_bi using btree (vi_tri_lap_dat, tinh_trang_hien_tai) TABLESPACE pg_default;

create index IF not exists idx_thiet_bi_ngay_bt_tiep_theo on public.thiet_bi using btree (ngay_bt_tiep_theo) TABLESPACE pg_default;

create index IF not exists idx_thiet_bi_status_maintenance on public.thiet_bi using btree (tinh_trang_hien_tai, ngay_bt_tiep_theo) TABLESPACE pg_default;

create index IF not exists idx_thiet_bi_ngay_nhap on public.thiet_bi using btree (ngay_nhap) TABLESPACE pg_default;

create index IF not exists idx_thiet_bi_ngay_dua_vao_su_dung on public.thiet_bi using btree (ngay_dua_vao_su_dung) TABLESPACE pg_default;

create index IF not exists idx_thiet_bi_gia_goc on public.thiet_bi using btree (gia_goc) TABLESPACE pg_default;

create index IF not exists idx_thiet_bi_han_bao_hanh on public.thiet_bi using btree (han_bao_hanh) TABLESPACE pg_default;

create index IF not exists idx_thiet_bi_nam_san_xuat on public.thiet_bi using btree (nam_san_xuat) TABLESPACE pg_default;

create index IF not exists idx_thiet_bi_dept_created on public.thiet_bi using btree (khoa_phong_quan_ly, created_at) TABLESPACE pg_default;

create index IF not exists idx_thiet_bi_ten_lower on public.thiet_bi using btree (lower(ten_thiet_bi)) TABLESPACE pg_default;

create index IF not exists idx_thiet_bi_ma_lower on public.thiet_bi using btree (lower(ma_thiet_bi)) TABLESPACE pg_default;

create index IF not exists idx_thiet_bi_don_vi on public.thiet_bi using btree (don_vi) TABLESPACE pg_default;

create index IF not exists idx_thiet_bi_don_vi_active on public.thiet_bi using btree (don_vi) TABLESPACE pg_default
where
  (don_vi is not null);

create index IF not exists idx_thiet_bi_tenant_status_dept on public.thiet_bi using btree (don_vi, tinh_trang_hien_tai, khoa_phong_quan_ly) TABLESPACE pg_default;

create index IF not exists idx_thiet_bi_text_search on public.thiet_bi using gin (
  to_tsvector(
    'simple'::regconfig,
    (
      (COALESCE(ten_thiet_bi, ''::text) || ' '::text) || COALESCE(ma_thiet_bi, ''::text)
    )
  )
) TABLESPACE pg_default;

create index IF not exists idx_thiet_bi_search on public.thiet_bi using gin (
  to_tsvector(
    'simple'::regconfig,
    (
      (COALESCE(ten_thiet_bi, ''::text) || ' '::text) || COALESCE(ma_thiet_bi, ''::text)
    )
  )
) TABLESPACE pg_default;

create index IF not exists idx_thiet_bi_tenant_next_bt on public.thiet_bi using btree (don_vi, ngay_bt_tiep_theo) TABLESPACE pg_default;


create table public.yeu_cau_sua_chua (
  id bigint generated by default as identity not null,
  thiet_bi_id bigint not null,
  mo_ta_su_co text not null,
  hang_muc_sua_chua text null,
  ngay_mong_muon_hoan_thanh date null,
  trang_thai text not null default 'Chờ xử lý'::text,
  nguoi_yeu_cau text null,
  ngay_yeu_cau timestamp with time zone not null default now(),
  ngay_duyet timestamp with time zone null,
  ngay_hoan_thanh timestamp with time zone null,
  don_vi_thuc_hien character varying(20) null default 'noi_bo'::character varying,
  ten_don_vi_thue text null,
  ket_qua_sua_chua text null,
  ly_do_khong_hoan_thanh text null,
  nguoi_duyet text null,
  nguoi_xac_nhan text null,
  constraint yeu_cau_sua_chua_pkey primary key (id),
  constraint yeu_cau_sua_chua_thiet_bi_id_fkey foreign KEY (thiet_bi_id) references thiet_bi (id) on delete CASCADE,
  constraint yeu_cau_sua_chua_don_vi_thuc_hien_check check (
    (
      (don_vi_thuc_hien)::text = any (
        array[
          ('noi_bo'::character varying)::text,
          ('thue_ngoai'::character varying)::text
        ]
      )
    )
  )
) TABLESPACE pg_default;

create index IF not exists idx_yeu_cau_sua_chua_don_vi_thuc_hien on public.yeu_cau_sua_chua using btree (don_vi_thuc_hien) TABLESPACE pg_default;

create index IF not exists idx_yeu_cau_sua_chua_external_repair on public.yeu_cau_sua_chua using btree (don_vi_thuc_hien, ten_don_vi_thue) TABLESPACE pg_default
where
  ((don_vi_thuc_hien)::text = 'thue_ngoai'::text);

create index IF not exists idx_yeu_cau_sua_chua_trang_thai on public.yeu_cau_sua_chua using btree (trang_thai) TABLESPACE pg_default;

create index IF not exists idx_yeu_cau_sua_chua_thiet_bi_id on public.yeu_cau_sua_chua using btree (thiet_bi_id) TABLESPACE pg_default;

create index IF not exists idx_yeu_cau_sua_chua_ngay_yeu_cau on public.yeu_cau_sua_chua using btree (ngay_yeu_cau) TABLESPACE pg_default;

create index IF not exists idx_yeu_cau_sua_chua_ngay_hoan_thanh on public.yeu_cau_sua_chua using btree (ngay_hoan_thanh) TABLESPACE pg_default;

create index IF not exists idx_yeu_cau_sua_chua_nguoi_yeu_cau on public.yeu_cau_sua_chua using btree (nguoi_yeu_cau) TABLESPACE pg_default;

create index IF not exists idx_yeu_cau_sua_chua_search_text on public.yeu_cau_sua_chua using gin (mo_ta_su_co extensions.gin_trgm_ops) TABLESPACE pg_default;

create index IF not exists idx_yeu_cau_sua_chua_status_date on public.yeu_cau_sua_chua using btree (trang_thai, ngay_yeu_cau) TABLESPACE pg_default;

create index IF not exists idx_yeu_cau_sua_chua_thiet_bi_don_vi on public.yeu_cau_sua_chua using btree (thiet_bi_id) TABLESPACE pg_default;

create index IF not exists idx_yeu_cau_sua_chua_text_search on public.yeu_cau_sua_chua using gin (
  to_tsvector(
    'simple'::regconfig,
    (
      (COALESCE(mo_ta_su_co, ''::text) || ' '::text) || COALESCE(hang_muc_sua_chua, ''::text)
    )
  )
) TABLESPACE pg_default;


create table public.yeu_cau_luan_chuyen (
  id bigint generated always as identity not null,
  ma_yeu_cau text not null,
  thiet_bi_id bigint not null,
  loai_hinh text not null,
  trang_thai text not null default 'cho_duyet'::text,
  nguoi_yeu_cau_id bigint null,
  ly_do_luan_chuyen text not null,
  khoa_phong_hien_tai text null,
  khoa_phong_nhan text null,
  muc_dich text null,
  don_vi_nhan text null,
  dia_chi_don_vi text null,
  nguoi_lien_he text null,
  so_dien_thoai text null,
  ngay_du_kien_tra timestamp with time zone null,
  ngay_ban_giao timestamp with time zone null,
  ngay_hoan_tra timestamp with time zone null,
  ngay_hoan_thanh timestamp with time zone null,
  nguoi_duyet_id bigint null,
  ngay_duyet timestamp with time zone null,
  ghi_chu_duyet text null,
  created_at timestamp with time zone null default now(),
  updated_at timestamp with time zone null default now(),
  created_by bigint null,
  updated_by bigint null,
  constraint yeu_cau_luan_chuyen_pkey primary key (id),
  constraint yeu_cau_luan_chuyen_thiet_bi_id_fkey foreign KEY (thiet_bi_id) references thiet_bi (id) on delete CASCADE,
  constraint yeu_cau_luan_chuyen_nguoi_refs_1 foreign KEY (nguoi_yeu_cau_id) references nhan_vien (id),
  constraint yeu_cau_luan_chuyen_nguoi_refs_2 foreign KEY (created_by) references nhan_vien (id),
  constraint yeu_cau_luan_chuyen_nguoi_refs_3 foreign KEY (updated_by) references nhan_vien (id),
  constraint yeu_cau_luan_chuyen_nguoi_refs_4 foreign KEY (nguoi_duyet_id) references nhan_vien (id),
  constraint yeu_cau_luan_chuyen_trang_thai_check check (
    (
      trang_thai = any (
        array[
          'cho_duyet'::text,
          'da_duyet'::text,
          'dang_luan_chuyen'::text,
          'da_ban_giao'::text,
          'hoan_thanh'::text
        ]
      )
    )
  ),
  constraint yeu_cau_luan_chuyen_muc_dich_check check (
    (
      (muc_dich is null)
      or (
        muc_dich = any (
          array[
            'sua_chua'::text,
            'cho_muon'::text,
            'thanh_ly'::text,
            'khac'::text
          ]
        )
      )
    )
  ),
  constraint yeu_cau_luan_chuyen_loai_hinh_check check (
    (
      loai_hinh = any (array['noi_bo'::text, 'ben_ngoai'::text])
    )
  )
) TABLESPACE pg_default;

create index IF not exists idx_yeu_cau_luan_chuyen_trang_thai on public.yeu_cau_luan_chuyen using btree (trang_thai) TABLESPACE pg_default;

create index IF not exists idx_yeu_cau_luan_chuyen_loai_hinh on public.yeu_cau_luan_chuyen using btree (loai_hinh) TABLESPACE pg_default;

create index IF not exists idx_yeu_cau_luan_chuyen_thiet_bi on public.yeu_cau_luan_chuyen using btree (thiet_bi_id) TABLESPACE pg_default;

create index IF not exists idx_yeu_cau_luan_chuyen_created_at on public.yeu_cau_luan_chuyen using btree (created_at) TABLESPACE pg_default;

create index IF not exists idx_yclc_created_by on public.yeu_cau_luan_chuyen using btree (created_by) TABLESPACE pg_default;

create index IF not exists idx_yclc_nguoi_yeu_cau_id on public.yeu_cau_luan_chuyen using btree (nguoi_yeu_cau_id) TABLESPACE pg_default;

create index IF not exists idx_yclc_updated_by on public.yeu_cau_luan_chuyen using btree (updated_by) TABLESPACE pg_default;

create index IF not exists idx_yclc_nguoi_duyet_id on public.yeu_cau_luan_chuyen using btree (nguoi_duyet_id) TABLESPACE pg_default;

create index IF not exists idx_yclc_thiet_bi_id on public.yeu_cau_luan_chuyen using btree (thiet_bi_id) TABLESPACE pg_default;

create trigger trigger_generate_ma_yeu_cau_luan_chuyen BEFORE INSERT on yeu_cau_luan_chuyen for EACH row when (
  new.ma_yeu_cau is null
  or new.ma_yeu_cau = ''::text
)
execute FUNCTION generate_ma_yeu_cau_luan_chuyen ();