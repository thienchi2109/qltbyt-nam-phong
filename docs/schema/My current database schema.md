-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.audit_logs (
  id bigint NOT NULL DEFAULT nextval('audit_logs_id_seq'::regclass),
  admin_user_id bigint NOT NULL,
  admin_username text NOT NULL,
  action_type text NOT NULL,
  target_user_id bigint,
  target_username text,
  action_details jsonb,
  ip_address inet,
  user_agent text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  entity_type text,
  entity_id bigint,
  entity_label text,
  tenant_don_vi text,
  CONSTRAINT audit_logs_pkey PRIMARY KEY (id),
  CONSTRAINT fk_admin_user FOREIGN KEY (admin_user_id) REFERENCES public.nhan_vien(id),
  CONSTRAINT fk_target_user FOREIGN KEY (target_user_id) REFERENCES public.nhan_vien(id)
);
CREATE TABLE public.cong_viec_bao_tri (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  ke_hoach_id bigint NOT NULL,
  thiet_bi_id bigint,
  loai_cong_viec text,
  diem_hieu_chuan text,
  don_vi_thuc_hien text,
  thang_1 boolean DEFAULT false,
  thang_2 boolean DEFAULT false,
  thang_3 boolean DEFAULT false,
  thang_4 boolean DEFAULT false,
  thang_5 boolean DEFAULT false,
  thang_6 boolean DEFAULT false,
  thang_7 boolean DEFAULT false,
  thang_8 boolean DEFAULT false,
  thang_9 boolean DEFAULT false,
  thang_10 boolean DEFAULT false,
  thang_11 boolean DEFAULT false,
  thang_12 boolean DEFAULT false,
  ghi_chu text,
  thang_1_hoan_thanh boolean DEFAULT false,
  thang_2_hoan_thanh boolean DEFAULT false,
  thang_3_hoan_thanh boolean DEFAULT false,
  thang_4_hoan_thanh boolean DEFAULT false,
  thang_5_hoan_thanh boolean DEFAULT false,
  thang_6_hoan_thanh boolean DEFAULT false,
  thang_7_hoan_thanh boolean DEFAULT false,
  thang_8_hoan_thanh boolean DEFAULT false,
  thang_9_hoan_thanh boolean DEFAULT false,
  thang_10_hoan_thanh boolean DEFAULT false,
  thang_11_hoan_thanh boolean DEFAULT false,
  thang_12_hoan_thanh boolean DEFAULT false,
  ngay_hoan_thanh_1 timestamp with time zone,
  ngay_hoan_thanh_2 timestamp with time zone,
  ngay_hoan_thanh_3 timestamp with time zone,
  ngay_hoan_thanh_4 timestamp with time zone,
  ngay_hoan_thanh_5 timestamp with time zone,
  ngay_hoan_thanh_6 timestamp with time zone,
  ngay_hoan_thanh_7 timestamp with time zone,
  ngay_hoan_thanh_8 timestamp with time zone,
  ngay_hoan_thanh_9 timestamp with time zone,
  ngay_hoan_thanh_10 timestamp with time zone,
  ngay_hoan_thanh_11 timestamp with time zone,
  ngay_hoan_thanh_12 timestamp with time zone,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT cong_viec_bao_tri_pkey PRIMARY KEY (id),
  CONSTRAINT cong_viec_bao_tri_ke_hoach_id_fkey FOREIGN KEY (ke_hoach_id) REFERENCES public.ke_hoach_bao_tri(id),
  CONSTRAINT cong_viec_bao_tri_thiet_bi_id_fkey FOREIGN KEY (thiet_bi_id) REFERENCES public.thiet_bi(id)
);
CREATE TABLE public.dia_ban (
  id bigint NOT NULL DEFAULT nextval('dia_ban_id_seq'::regclass),
  ma_dia_ban text NOT NULL UNIQUE,
  ten_dia_ban text NOT NULL,
  ten_lanh_dao text,
  so_luong_don_vi_truc_thuoc integer NOT NULL DEFAULT 0 CHECK (so_luong_don_vi_truc_thuoc >= 0),
  dia_chi text,
  logo_dia_ban_url text,
  cap_do text,
  parent_id bigint,
  active boolean DEFAULT true,
  sort_order integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT dia_ban_pkey PRIMARY KEY (id),
  CONSTRAINT dia_ban_parent_id_fkey FOREIGN KEY (parent_id) REFERENCES public.dia_ban(id)
);
CREATE TABLE public.don_vi (
  id bigint NOT NULL DEFAULT nextval('don_vi_id_seq'::regclass),
  code text UNIQUE,
  name text NOT NULL,
  active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  membership_quota integer,
  logo_url text,
  dia_ban_id bigint,
  google_drive_folder_url text,
  CONSTRAINT don_vi_pkey PRIMARY KEY (id),
  CONSTRAINT don_vi_dia_ban_id_fkey FOREIGN KEY (dia_ban_id) REFERENCES public.dia_ban(id)
);
CREATE TABLE public.file_dinh_kem (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  thiet_bi_id bigint NOT NULL,
  ten_file text NOT NULL,
  duong_dan_luu_tru text NOT NULL,
  ngay_tai_len timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT file_dinh_kem_pkey PRIMARY KEY (id),
  CONSTRAINT file_dinh_kem_thiet_bi_id_fkey FOREIGN KEY (thiet_bi_id) REFERENCES public.thiet_bi(id)
);
CREATE TABLE public.internal_settings (
  key text NOT NULL,
  value text NOT NULL,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT internal_settings_pkey PRIMARY KEY (key)
);
CREATE TABLE public.ke_hoach_bao_tri (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  ten_ke_hoach text NOT NULL,
  nam integer NOT NULL,
  khoa_phong text,
  trang_thai text NOT NULL DEFAULT 'Bản nháp'::text,
  ngay_phe_duyet timestamp with time zone,
  nguoi_lap_ke_hoach text,
  loai_cong_viec text,
  ly_do_khong_duyet text,
  nguoi_duyet text,
  don_vi bigint,
  CONSTRAINT ke_hoach_bao_tri_pkey PRIMARY KEY (id),
  CONSTRAINT ke_hoach_bao_tri_don_vi_fkey FOREIGN KEY (don_vi) REFERENCES public.don_vi(id)
);
CREATE TABLE public.khoa_phong_to_don_vi (
  khoa_phong text NOT NULL,
  don_vi_code text,
  don_vi_name text,
  CONSTRAINT khoa_phong_to_don_vi_pkey PRIMARY KEY (khoa_phong)
);
CREATE TABLE public.lich_su_thiet_bi (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  thiet_bi_id bigint NOT NULL,
  ngay_thuc_hien timestamp with time zone NOT NULL DEFAULT now(),
  loai_su_kien text NOT NULL,
  mo_ta text NOT NULL,
  chi_tiet jsonb,
  yeu_cau_id bigint,
  CONSTRAINT lich_su_thiet_bi_pkey PRIMARY KEY (id),
  CONSTRAINT lich_su_thiet_bi_thiet_bi_id_fkey FOREIGN KEY (thiet_bi_id) REFERENCES public.thiet_bi(id),
  CONSTRAINT lich_su_thiet_bi_yeu_cau_id_fkey FOREIGN KEY (yeu_cau_id) REFERENCES public.yeu_cau_sua_chua(id)
);
CREATE TABLE public.nhan_vien (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  username text NOT NULL UNIQUE,
  password text NOT NULL,
  full_name text,
  created_at timestamp with time zone DEFAULT now(),
  role text NOT NULL,
  khoa_phong text,
  hashed_password text,
  is_active boolean DEFAULT true,
  password_reset_required boolean DEFAULT false,
  password_reset_at timestamp with time zone,
  disabled_at timestamp with time zone,
  disabled_reason text,
  password_changed_at timestamp with time zone DEFAULT now(),
  failed_attempts integer NOT NULL DEFAULT 0,
  don_vi bigint,
  current_don_vi bigint,
  dia_ban_id bigint,
  CONSTRAINT nhan_vien_pkey PRIMARY KEY (id),
  CONSTRAINT nhan_vien_don_vi_fkey FOREIGN KEY (don_vi) REFERENCES public.don_vi(id),
  CONSTRAINT nhan_vien_current_don_vi_fkey FOREIGN KEY (current_don_vi) REFERENCES public.don_vi(id),
  CONSTRAINT nhan_vien_dia_ban_id_fkey FOREIGN KEY (dia_ban_id) REFERENCES public.dia_ban(id)
);
CREATE TABLE public.nhat_ky_su_dung (
  id integer NOT NULL DEFAULT nextval('nhat_ky_su_dung_id_seq'::regclass),
  thiet_bi_id integer NOT NULL,
  nguoi_su_dung_id integer,
  thoi_gian_bat_dau timestamp with time zone NOT NULL,
  thoi_gian_ket_thuc timestamp with time zone,
  tinh_trang_thiet_bi character varying,
  ghi_chu text,
  trang_thai character varying DEFAULT 'dang_su_dung'::character varying CHECK (trang_thai::text = ANY (ARRAY['dang_su_dung'::character varying::text, 'hoan_thanh'::character varying::text])),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT nhat_ky_su_dung_pkey PRIMARY KEY (id),
  CONSTRAINT nhat_ky_su_dung_nguoi_su_dung_id_fkey FOREIGN KEY (nguoi_su_dung_id) REFERENCES public.nhan_vien(id),
  CONSTRAINT nhat_ky_su_dung_thiet_bi_id_fkey FOREIGN KEY (thiet_bi_id) REFERENCES public.thiet_bi(id)
);
CREATE TABLE public.thiet_bi (
  ma_thiet_bi text NOT NULL UNIQUE,
  ten_thiet_bi text,
  model text,
  serial text,
  cau_hinh_thiet_bi text,
  phu_kien_kem_theo text,
  hang_san_xuat text,
  noi_san_xuat text,
  nam_san_xuat integer,
  ngay_nhap text,
  ngay_dua_vao_su_dung text,
  nguon_kinh_phi text,
  gia_goc numeric,
  nam_tinh_hao_mon integer,
  ty_le_hao_mon text,
  han_bao_hanh text,
  vi_tri_lap_dat text,
  nguoi_dang_truc_tiep_quan_ly text,
  khoa_phong_quan_ly text,
  tinh_trang_hien_tai text,
  ghi_chu text,
  chu_ky_bt_dinh_ky integer,
  ngay_bt_tiep_theo date,
  chu_ky_hc_dinh_ky integer,
  ngay_hc_tiep_theo date,
  chu_ky_kd_dinh_ky integer,
  ngay_kd_tiep_theo date,
  phan_loai_theo_nd98 text,
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  don_vi bigint,
  nguon_nhap text DEFAULT 'manual'::text,
  so_luu_hanh character varying,
  CONSTRAINT thiet_bi_pkey PRIMARY KEY (id),
  CONSTRAINT thiet_bi_don_vi_fkey FOREIGN KEY (don_vi) REFERENCES public.don_vi(id)
);
CREATE TABLE public.user_don_vi_memberships (
  user_id bigint NOT NULL,
  don_vi bigint NOT NULL,
  role_override text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT user_don_vi_memberships_pkey PRIMARY KEY (user_id, don_vi),
  CONSTRAINT user_don_vi_memberships_user_fkey FOREIGN KEY (user_id) REFERENCES public.nhan_vien(id),
  CONSTRAINT user_don_vi_memberships_don_vi_fkey FOREIGN KEY (don_vi) REFERENCES public.don_vi(id)
);
CREATE TABLE public.user_fcm_tokens (
  id bigint NOT NULL DEFAULT nextval('user_fcm_tokens_id_seq'::regclass),
  user_id uuid NOT NULL,
  fcm_token text NOT NULL,
  updated_at timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_fcm_tokens_pkey PRIMARY KEY (id),
  CONSTRAINT user_fcm_tokens_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.yeu_cau_luan_chuyen (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  ma_yeu_cau text NOT NULL,
  thiet_bi_id bigint NOT NULL,
  loai_hinh text NOT NULL CHECK (loai_hinh = ANY (ARRAY['noi_bo'::text, 'ben_ngoai'::text])),
  trang_thai text NOT NULL DEFAULT 'cho_duyet'::text CHECK (trang_thai = ANY (ARRAY['cho_duyet'::text, 'da_duyet'::text, 'dang_luan_chuyen'::text, 'da_ban_giao'::text, 'hoan_thanh'::text])),
  nguoi_yeu_cau_id bigint,
  ly_do_luan_chuyen text NOT NULL,
  khoa_phong_hien_tai text,
  khoa_phong_nhan text,
  muc_dich text CHECK (muc_dich IS NULL OR (muc_dich = ANY (ARRAY['sua_chua'::text, 'cho_muon'::text, 'thanh_ly'::text, 'khac'::text]))),
  don_vi_nhan text,
  dia_chi_don_vi text,
  nguoi_lien_he text,
  so_dien_thoai text,
  ngay_du_kien_tra timestamp with time zone,
  ngay_ban_giao timestamp with time zone,
  ngay_hoan_tra timestamp with time zone,
  ngay_hoan_thanh timestamp with time zone,
  nguoi_duyet_id bigint,
  ngay_duyet timestamp with time zone,
  ghi_chu_duyet text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  created_by bigint,
  updated_by bigint,
  CONSTRAINT yeu_cau_luan_chuyen_pkey PRIMARY KEY (id),
  CONSTRAINT yeu_cau_luan_chuyen_thiet_bi_id_fkey FOREIGN KEY (thiet_bi_id) REFERENCES public.thiet_bi(id),
  CONSTRAINT yeu_cau_luan_chuyen_nguoi_refs_1 FOREIGN KEY (nguoi_yeu_cau_id) REFERENCES public.nhan_vien(id),
  CONSTRAINT yeu_cau_luan_chuyen_nguoi_refs_2 FOREIGN KEY (created_by) REFERENCES public.nhan_vien(id),
  CONSTRAINT yeu_cau_luan_chuyen_nguoi_refs_3 FOREIGN KEY (updated_by) REFERENCES public.nhan_vien(id),
  CONSTRAINT yeu_cau_luan_chuyen_nguoi_refs_4 FOREIGN KEY (nguoi_duyet_id) REFERENCES public.nhan_vien(id)
);
CREATE TABLE public.yeu_cau_sua_chua (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  thiet_bi_id bigint NOT NULL,
  mo_ta_su_co text NOT NULL,
  hang_muc_sua_chua text,
  ngay_mong_muon_hoan_thanh date,
  trang_thai text NOT NULL DEFAULT 'Chờ xử lý'::text,
  nguoi_yeu_cau text,
  ngay_yeu_cau timestamp with time zone NOT NULL DEFAULT now(),
  ngay_duyet timestamp with time zone,
  ngay_hoan_thanh timestamp with time zone,
  don_vi_thuc_hien character varying DEFAULT 'noi_bo'::character varying CHECK (don_vi_thuc_hien::text = ANY (ARRAY['noi_bo'::character varying::text, 'thue_ngoai'::character varying::text])),
  ten_don_vi_thue text,
  ket_qua_sua_chua text,
  ly_do_khong_hoan_thanh text,
  nguoi_duyet text,
  nguoi_xac_nhan text,
  CONSTRAINT yeu_cau_sua_chua_pkey PRIMARY KEY (id),
  CONSTRAINT yeu_cau_sua_chua_thiet_bi_id_fkey FOREIGN KEY (thiet_bi_id) REFERENCES public.thiet_bi(id)
);