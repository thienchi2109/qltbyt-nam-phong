# Kanban RPC Security Fix - P1 JWT Claims Fallback Vulnerability

**Date**: October 12, 2025  
**Severity**: P1 (Security Vulnerability)  
**Status**: ✅ FIXED  
**Related Migration**: `supabase/migrations/2025-10-12_transfer_kanban/20251012120000_kanban_server_side_filtering.sql`

---

## Executive Summary

Fixed a **P1 security vulnerability** in Kanban RPC functions where missing JWT claims defaulted to `'global'` role, bypassing tenant isolation and exposing all facilities' data.

**Impact**: Any request with missing role claims would be granted global access instead of being denied.

**Fix**: Removed unsafe `'global'` fallback and added explicit null check with fail-secure error.

---

## Vulnerability Details

### Problem Code (BEFORE)

```sql
-- UNSAFE: Defaults to 'global' when claims missing
v_user_role := COALESCE(
  v_jwt_claims ->> 'app_role',
  v_jwt_claims ->> 'role',
  'global'  -- ❌ DANGEROUS FALLBACK
);

-- Validates role but accepts 'global' from fallback
IF v_user_role NOT IN ('user', 'technician', 'to_qltb', 'regional_leader', 'global') THEN
  RAISE EXCEPTION 'Unauthorized: Invalid role';
END IF;
```

### Attack Scenarios

| Scenario | Vulnerability | Impact |
|----------|---------------|---------|
| **Proxy misconfiguration** | Claims not stamped | Global access granted |
| **JWT parsing error** | NULL claims object | Global access granted |
| **Future refactor** | Claim key renamed | Global access granted |
| **Malformed JWT** | Claims missing | Global access granted |
| **Developer error** | Forgot to set claims | Global access granted |

### Security Principles Violated

1. **Principle of Least Privilege**: Missing info should grant MINIMUM access, not MAXIMUM
2. **Fail-Secure**: System should deny access on errors, not grant elevated privileges
3. **Defense in Depth**: Should require explicit authorization, not default to privileged role
4. **Explicit over Implicit**: Role should be explicitly provided, not assumed

---

## Fix Implementation

### Secure Code (AFTER)

```sql
-- SECURE: No fallback to privileged role
v_user_role := COALESCE(
  v_jwt_claims ->> 'app_role',
  v_jwt_claims ->> 'role'
  -- ✅ No default - will be NULL if claims missing
);
v_user_don_vi := NULLIF(v_jwt_claims ->> 'don_vi', '')::BIGINT;

-- Validate role exists and is allowed (fail-secure: deny access if claim missing)
IF v_user_role IS NULL THEN
  RAISE EXCEPTION 'Unauthorized: Missing role claim in JWT';
END IF;

IF v_user_role NOT IN ('user', 'technician', 'to_qltb', 'regional_leader', 'global') THEN
  RAISE EXCEPTION 'Unauthorized: Invalid role';
END IF;
```

### Changes Made

**File**: `supabase/migrations/2025-10-12_transfer_kanban/20251012120000_kanban_server_side_filtering.sql`

**Functions Fixed**:
1. `get_transfers_kanban()` (lines 73-86)
2. `get_transfer_counts()` (lines 206-219)

**Changes**:
- Removed `'global'` from COALESCE fallback
- Added explicit NULL check before role validation
- Added clear error message: `'Unauthorized: Missing role claim in JWT'`
- Updated comments to emphasize fail-secure behavior

---

## Security Analysis

### Before Fix (INSECURE)

```
Request with missing claims
  ↓
v_user_role := COALESCE(app_role, role, 'global')
  ↓
v_user_role = 'global'  ← DANGEROUS
  ↓
IF v_user_role NOT IN (..., 'global') → PASS
  ↓
IF v_user_role NOT IN ('global', 'regional_leader') → PASS
  ↓
Tenant isolation BYPASSED
  ↓
Return ALL facilities' data
```

### After Fix (SECURE)

```
Request with missing claims
  ↓
v_user_role := COALESCE(app_role, role)
  ↓
v_user_role = NULL
  ↓
IF v_user_role IS NULL → FAIL
  ↓
RAISE EXCEPTION 'Unauthorized: Missing role claim in JWT'
  ↓
Request DENIED (403 Forbidden)
  ↓
No data exposed
```

---

## Testing Recommendations

### Unit Tests (SQL)

```sql
-- Test 1: Normal request with valid claims → Should succeed
SELECT * FROM get_transfers_kanban(p_limit := 10);

-- Test 2: Request with missing claims → Should fail
-- (Simulate by modifying RPC proxy to not stamp claims)
-- Expected: ERROR: Unauthorized: Missing role claim in JWT

-- Test 3: Request with invalid role → Should fail
-- (Modify proxy to stamp invalid role like 'hacker')
-- Expected: ERROR: Unauthorized: Invalid role
```

### Integration Tests

```typescript
// Test 1: Valid JWT with role claim
const response1 = await callRpc({ 
  fn: 'get_transfers_kanban', 
  args: { p_limit: 10 } 
});
expect(response1).toBeDefined();

// Test 2: Malformed JWT (missing role)
// Mock RPC proxy to skip role claim
const response2 = await callRpcWithoutRole({ 
  fn: 'get_transfers_kanban', 
  args: { p_limit: 10 } 
});
expect(response2).toThrow('Missing role claim in JWT');
```

### Security Audit Checklist

- [ ] Verify no `'global'` fallback in any RPC function
- [ ] Check all COALESCE statements for unsafe defaults
- [ ] Confirm explicit NULL checks before authorization
- [ ] Test with missing/malformed JWTs
- [ ] Verify error messages don't leak sensitive info
- [ ] Check tenant isolation still works for valid requests

---

## Impact Assessment

### Before Fix

**Risk Level**: HIGH  
**CVSS Score**: ~7.5 (High) - Authorization Bypass  
**Exploitability**: Medium (requires proxy misconfiguration or JWT manipulation)  
**Impact**: High (full data exposure across all tenants)

### After Fix

**Risk Level**: NONE  
**Behavior**: Fail-secure - deny access when claims missing  
**Impact**: Legitimate requests unaffected, malicious/broken requests denied

---

## Related Vulnerabilities Checked

### Other RPC Functions Status

Checked other critical RPC functions for same vulnerability:

| Function | Status | Notes |
|----------|--------|-------|
| `equipment_list_enhanced` | ✅ SAFE | Has explicit NULL check |
| `maintenance_request_list` | ✅ SAFE | Has explicit NULL check |
| `repair_request_list` | ✅ SAFE | Has explicit NULL check |
| `get_transfers_kanban` | ✅ FIXED | This fix |
| `get_transfer_counts` | ✅ FIXED | This fix |

**Conclusion**: Only the new Kanban RPC functions had this vulnerability. Existing functions follow proper fail-secure patterns.

---

## Prevention Guidelines

### For Future RPC Functions

```sql
-- ✅ CORRECT PATTERN (fail-secure)
v_user_role := COALESCE(
  v_jwt_claims ->> 'app_role',
  v_jwt_claims ->> 'role'
  -- NO DEFAULT TO PRIVILEGED ROLE
);

-- Explicit NULL check
IF v_user_role IS NULL THEN
  RAISE EXCEPTION 'Unauthorized: Missing role claim in JWT';
END IF;

-- ❌ WRONG PATTERN (unsafe fallback)
v_user_role := COALESCE(
  v_jwt_claims ->> 'app_role',
  v_jwt_claims ->> 'role',
  'global'  -- NEVER DO THIS
);
```

### Security Review Checklist

When reviewing new RPC functions:
1. ✅ Check for COALESCE with privileged role defaults
2. ✅ Verify explicit NULL checks before authorization
3. ✅ Confirm tenant isolation logic is not bypassed
4. ✅ Test with missing/malformed JWT claims
5. ✅ Ensure error messages are informative but not sensitive

---

## Deployment Instructions

### Pre-Deployment

1. Review this fix in the migration file
2. Test locally with valid and invalid JWTs
3. Verify tenant isolation still works correctly
4. Check that legitimate users are not blocked

### Deployment Steps

```bash
# 1. Review the migration
cat supabase/migrations/2025-10-12_transfer_kanban/20251012120000_kanban_server_side_filtering.sql

# 2. Apply to Supabase (via SQL Editor)
# Copy the entire migration and run in Supabase Dashboard SQL Editor

# 3. Test with curl/Postman
curl -X POST https://your-project.supabase.co/rest/v1/rpc/get_transfers_kanban \
  -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
  -H "Content-Type: application/json" \
  -d '{"p_limit": 10}'

# Expected: Should return data for authenticated user's tenant

# 4. Test with malformed JWT (remove role claim from proxy temporarily)
# Expected: ERROR: Unauthorized: Missing role claim in JWT
```

### Post-Deployment

- [ ] Monitor error logs for "Missing role claim" errors
- [ ] Verify no legitimate users are blocked
- [ ] Confirm tenant isolation working correctly
- [ ] Check performance (NULL check has negligible impact)

---

## Key Learnings

### 1. Never Default to Privileged Roles

**Wrong**: `COALESCE(claim, 'global')`  
**Right**: `COALESCE(claim)` + explicit NULL check

### 2. Fail-Secure Principle

When in doubt, **DENY** access, don't **GRANT** it.

### 3. Defense in Depth

Even if proxy always stamps claims correctly:
- What if proxy gets refactored?
- What if JWT parsing fails?
- What if new claim key is used?

**Always validate at every layer.**

### 4. Explicit Authorization

Authorization should be **explicit**, never **implicit** or **default**.

### 5. Code Review Importance

This vulnerability was caught during code review before deployment.  
**Prevention > Detection > Response**

---

## References

- **OWASP Authorization Cheat Sheet**: https://cheatsheetseries.owasp.org/cheatsheets/Authorization_Cheat_Sheet.html
- **Principle of Least Privilege**: https://en.wikipedia.org/wiki/Principle_of_least_privilege
- **Fail-Secure Design**: https://owasp.org/www-community/Fail_securely

---

## Acknowledgments

**Discovered by**: Human code review  
**Fixed by**: GitHub Copilot  
**Severity Assessment**: P1 (Security Vulnerability)  
**Status**: ✅ Resolved before deployment

---

**Last Updated**: October 12, 2025  
**Git Branch**: `feat/rpc-enhancement`  
**Next Steps**: Include in next commit, apply migration before frontend deployment
